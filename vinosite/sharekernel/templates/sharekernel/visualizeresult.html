{% extends "base.html" %}

{% load staticfiles %}
{% block head %}
<script src="{% static 'sharekernel/vinoplot.js' %}"></script>
<script src="{% static 'sharekernel/vis.js' %}"></script>
<script src="{% static 'sharekernel/plotly-latest.min.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'sharekernel/vis.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'sharekernel/histogram.css' %}" />
{% endblock %}
{% block body %}
<div id="container">

    <div id="row"><div class="col-sm-12">
            <ol class="breadcrumb">
                <li><a href="{% url 'sharekernel:home' %}">Home</a></li>
                <li><a href="{% url 'sharekernel:visitviabilityproblem'  viabilityproblem.id %}">{{viabilityproblem.title}}</a></li>
                <li><a href="{% url 'sharekernel:visitresult'  result.id %}">{{result.title}}</a></li>
            </ol>
            {% include 'sharekernel/result_infobar.html' %}

        <h1>{{result.title}} : {{result.parameters.viabilityproblem.statevariables.count}}D state space</h1>
        {% if result.parameters.viabilityproblem.statevariables.count < 4 %}
        <div id="row">
            <div class="col-sm-10 col-sm-offset-1">
            <div class="form-inline">
                <div class="form-group">
                    <label for="ppa">{{result.parameters.viabilityproblem.statevariables.count}}D visualization with
                        </label>
                    <input type="text" class="form-control" id="ppa" value="50"> (max : {% if result.parameters.viabilityproblem.statevariables.count == 2 %}5000{% else %} 300{% endif %}) points per axis
                </div>
                <button id="viewPlotlyBW" class="btn btn-primary">Update visualization</button>
            </div>
<br>
            <div class="form-inline">
                <div class="form-group">
                  You can try to visualize the original ViNO but it may take a long time ....
                </div>
                <button id="viewPlotlyBWOriginal" class="btn btn-primary">Original ViNO</button>
            </div>

            <div id="viewPanelBW"></div>
<br><hr><br>
            </div>

        </div>

        {% endif%}


        <div id="row">
            <div class="col-sm-10 col-sm-offset-1">
            <div class="form-inline">
                <div class="form-group">
                    <label for="distanceppa">
                    {% if result.parameters.viabilityproblem.statevariables.count == 2 %}2D visualization
                    {% elif result.parameters.viabilityproblem.statevariables.count == 3 %} Visualization of 2D-sections
                    {% endif %}
                    of projection on a regular grid with </label>
                    <input type="text" class="form-control" id="distanceppa" value="50">    (max : 500) points per axis
                    with colors depending on the distance to the boundary
                 </div>
                {% if result.parameters.viabilityproblem.statevariables.count == 2 %}
                <button id="viewPlotlyColor" class="btn btn-primary">Update visualization</button>
                {% else %}
                <button id="viewPlotlyColorSectionUpdate" class="btn btn-primary">Update visualization</button>
                {% endif %}
            </div>
            {% if result.parameters.viabilityproblem.statevariables.count == 3 %}
            <div id="sectionDirections">
                  Coupes axes :

        {% for statevariable in staab %}
            {% if forloop.counter == 1 %}
            <input type='checkbox' name='dimension' value='{{statevariable}}' id='{{statevariable}}' checked = "checked" onchange='ShowAxes()'/>{{statevariable}}
            {% else %}
            <input type='checkbox' name='dimension' value='{{statevariable}}' id='{{statevariable}}' onchange='ShowAxes()'/>{{statevariable}}
            {% endif %}
        {% endfor %}
        ({{result.parameters.viabilityproblem.statevariables.count|add:"-2"}} checkbox(es) must be checked)



            </div>

            <div id="sectionAxes">


            </div>
            <div id="sectionSliders"></div>
            <div id="sliderValues"></div>
            {% endif %}
            <div id="viewPanel"></div>


            <br><hr><br>
            </div>

        </div>


        <div id="row">
            <div class="col-sm-10 col-sm-offset-1">

            <div class="form-inline">
                <div class="form-group">
                    <label for="maxvalue">Points repartition depending on their distance to the boundary class
                   (20 classes: 19 classes with equal width between 1 and </label>
                    <input type="text" class="form-control" id="maxvalue" value="5000"> (maxvalue), the 20th class for points whose distance value is bigger than maxvalue.
                </div>
                <button type="submit" id="viewHisto" class="btn btn-primary">View distance histogram</button>
            </div>
            <div id="histo"></div>
            <div id="labels"></div>
            <div class="spacer"></div>
            </div>

        </div>

            <div id='loading' style='display:none'>
                <img src="{% static 'sharekernel/images/ajax-loader.gif' %}"/>
            </div>


<!--
          <hr>
            <h1>Visualization</h1>
            {% if result.parameters.viabilityproblem.statevariables.count < 4 %}
            <div class="form-inline">
                <div class="form-group">
                    <label for="ppa">points per axis
                        {% if result.parameters.viabilityproblem.statevariables.count == 3 %}(max : 150){% else %}(max : 1000){% endif %}</label>
                    <input type="text" class="form-control" id="ppa" value="50">
                </div>
                <button id="viewPlotlyBW" class="btn btn-primary">View Vino</button>
            </div>
            <div id='loading' style='display:none'>
                <img src="{% static 'sharekernel/images/ajax-loader.gif' %}"/>
            </div>
            <div class="form-inline">
                <div class="form-group">
                    <label for="distanceppa">points per axis
                        {% if result.parameters.viabilityproblem.statevariables.count == 3 %}(max : 150){% else %}(max : 200){% endif %}</label>
                    <input type="text" class="form-control" id="distanceppa" value="50">
                </div>
                <button id="viewPlotlyColor" class="btn btn-primary">View distance</button>
            </div>
            <div id="viewPanel"></div>
            {% endif %}

            {% if result.parameters.viabilityproblem.statevariables.count > 2 %}
            <div class="form-inline">
                <div class="form-group">
                    <label for="sectiondistanceppa">points per axis (max : 200)</label>
                    <input type="text" class="form-control" id="sectiondistanceppa" value="50">
                </div>
                <button id="viewPlotlyColorSection" class="btn btn-primary">View distance 2D-section</button>
            </div>
            <div id="sectionDirections">

            </div>
            <div id="sectionAxes"></div>
            <div id="sectionSliders"></div>
            <div id="sliderValues"></div>
            <div id="viewSectionPanel"></div>

            {% endif %}

            <div class="form-inline">
                <div class="form-group">
                    <label for="distancehistoppa">points per axis (max : 200)</label>
                    <input type="text" class="form-control" id="distancehistoppa" value="200">
                </div>
                <div class="form-group">
                    <label for="maxvalue">max value</label>
                    <input type="text" class="form-control" id="maxvalue" value="5000">
                </div>
                <button type="submit" id="viewHisto" class="btn btn-primary">View distance histogram</button>
            </div>
            <div id="histo"></div>
            <div id="labels"></div>
            <div class="spacer"></div> -->
        </div>
    </div>
</div>

<script type="text/javascript">
    {% if result.parameters.viabilityproblem.statevariables.count < 4 %}

var ppainitial;
    {% if result.parameters.viabilityproblem.statevariables.count == 3 %}
ppainitial = 100;
    {% elif result.parameters.viabilityproblem.statevariables.count == 2 %}

ppainitial = 1000;
{% endif %}
document.getElementById("ppa").value = ppainitial;
ViNOVisu(ppainitial);
{% endif %}
{% if result.parameters.viabilityproblem.statevariables.count == 2 %}

document.getElementById("distanceppa").value = 50;
DistanceVinoVisu(50);
document.getElementById("maxvalue").value = 500;
ViNOHisto(500,50);
{% elif result.parameters.viabilityproblem.statevariables.count == 3 %}
document.getElementById("distanceppa").value = 30;
var tabinit = document.getElementsByName('dimension');
    tabinit[0].checked=true;

    for (init = 1; init < tabinit.length; init++){
        tabinit[init].checked=false;
    }
ShowAxes();
document.getElementById("maxvalue").value = 50;
ViNOHisto(50,30);

{% endif %}

var twoDsections = [];
var twoDsectionCoordinates = [];
var twoDsectionMins = [];
var twoDsectionMaxs = [];
var twoDsectionCmax = 0;
function loadAndPlot(url, callback) {
$('#loading').show();
$.ajax({ url: url,
        type: "POST",
        data: new FormData($('#uploadForm')[0]),
        processData: false,
        contentType: false,
        dataType:"json",
        success: callback,
        complete: function(){
        $('#loading').hide();
//			document.getElementById('loading').innerHTML = "";
        }
})
        return false;
}
$("#loading").ajaxStart(function(){ // Nous ciblons l'élément #loading qui est caché
    $(this).hide(); // Nous l'affichons quand la requête AJAX démarre
}).ajaxComplete(function() {
    $(this).hide();
});

function BarTrace (x, y) {
    var barTrace = {x:[], y:[], mode:'markers', type: 'scatter', markers: { color: 'rgb(55, 128, 191)', size: 2}, hoverinfo:'none' };
    barTrace.x.push(x[0]);
    barTrace.x.push(x[1]);
    barTrace.y.push(y[0]);
    barTrace.y.push(y[1]);
    return barTrace;
}

function bargridRectangle(x, y, xstep, ystep, colorline, fillcolor){
    var rectangle = {'type': 'rect', 'x0': x[0] - xstep, 'y0': y[0] - ystep, 'x1': x[1] + xstep, 'y1': y[1] + ystep, 'line': {'color': colorline, 'width': 1}, 'fillcolor': fillcolor};
    return rectangle;
}

function kdtreeRectangle(xmin, xmax, ymin, ymax, colorline, fillcolor){
    var rectangle = {'type': 'rect', 'x0': xmin, 'y0': ymin, 'x1': xmax, 'y1': ymax, 'line': {'color': colorline, 'width': 1}, 'fillcolor': fillcolor};
    return rectangle;
}

function bargridPlot(url, x, container, colormarker, colorline, fillcolor){
    if (isNaN(x) || x == "%20" || x > 5000) {
        text = "Input not valid : " + x;
        container.innerHTML = text;
    } else {
        url = url.replace("0", x);
        loadAndPlot(url, function (data) {
            var items = {x:[], y:[], mode:'markers', type: 'scatter', marker: { size : 2, color: colormarker }, hoverinfo:'none' };
            var trace = [];
            var tracebis = [];
            var x = [];
            var y = [];
            var map = [];
            var mapinit = [x, y];
            var mapitems = [];
            var mapinititems = [items.x, items.y];
            var xstep, ystep;
            var xbounds = [];
            var ybounds = [];
            $.each(data, function(index, bar) {
                if (index == 0){
                    xstep = bar[4] / 2;
                    ystep = bar[5] / 2;
                    xbounds.push(bar[0]);
                    xbounds.push(bar[2]);
                    ybounds.push(bar[1]);
                    ybounds.push(bar[3]);
                    map.push(mapinit[bar[6]]);
                    map.push(mapinit[bar[7]]);
                    mapitems.push(mapinititems[bar[6]]);
                    mapitems.push(mapinititems[bar[7]]);
                    x.push(0);
                    x.push(1);
                    y.push(0);
                    y.push(1);
                } else {
                    map[0][0] = bar[0];
                    map[0][1] = bar[0];
                    map[1][0] = bar[1];
                    map[1][1] = bar[2];
                    mapitems[0].push(bar[0]);
                    mapitems[0].push(bar[0]);
                    mapitems[1].push(bar[1]);
                    mapitems[1].push(bar[2]);
                    tracebis.push(bargridRectangle(x, y, xstep, ystep, colorline, fillcolor));
                }
            });
            var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, shapes : tracebis, xaxis:{title : '{{staab|first}}',range : xbounds}, yaxis:{title : '{{staab|last}}',range : ybounds}};
            trace = [items];
            Plotly.newPlot(container, trace, layout);
        })
    }
}

function bargridRectangle3D(x, y, z, xstep, ystep, zstep, facecolor){
    var i = [7, 0, 0, 0, 4, 4, 2, 6, 4, 0, 3, 7];
    var j = [3, 4, 1, 2, 5, 6, 5, 5, 0, 1, 2, 2];
    var k = [0, 7, 2, 3, 6, 7, 1, 2, 5, 5, 7, 6];
    var rectangle3D = {x: [x[0] - xstep, x[0] - xstep, x[1] + xstep, x[1] + xstep, x[0] - xstep, x[0] - xstep, x[1] + xstep, x[1] + xstep], y: [y[0] - ystep, y[1] + ystep, y[1] + ystep, y[0] - ystep, y[0] - ystep, y[1] + ystep, y[1] + ystep, y[0] - ystep], z: [z[0] - zstep, z[0] - zstep, z[0] - zstep, z[0] - zstep, z[1] + zstep, z[1] + zstep, z[1] + zstep, z[1] + zstep], i: i, j: j, k: k, facecolor: facecolor, type: 'mesh3d'};
    return rectangle3D;
}


function bargridPlot3D(url, x, container, colormarker, colorline, fillcolor){
    if (isNaN(x) || x == "%20" || x > 300) {
        text = "Input not valid : " + x;
        container.innerHTML = text;
    } else {
        url = url.replace("/0/", "/" + x + "/");
        loadAndPlot(url, function (data) {
            var items = {x:[], y:[], z:[], mode:'markers', type: 'scatter3d', marker: { size : 1, color: [] }, hoverinfo:'none' };
            var trace = [];
            var tracebis = [];
            var x = [];
            var y = [];
            var z = [];
            var map = [];
            var mapinit = [x, y, z];
            var mapitems = [items.x, items.y, items.z];
            var mapinititems = [items.x, items.y, items.z];
            var xstep, ystep, zstep;
            var xbounds = [];
            var ybounds = [];
            var zbounds = [];
            $.each(data, function(index, bar) {
                if (bar.length > 4){
                    xstep = bar[6] / 2;
                    ystep = bar[7] / 2;
                    zstep = bar[8] / 2;
                    xbounds.push(bar[0]);
                    xbounds.push(bar[3]);
                    ybounds.push(bar[1]);
                    ybounds.push(bar[4]);
                    zbounds.push(bar[2]);
                    zbounds.push(bar[5]);
                    map.push(mapinit[bar[9]]);
                    map.push(mapinit[bar[10]]);
                    map.push(mapinit[bar[11]]);
                    mapitems[0] = mapinititems[bar[9]];
                    mapitems[1] = mapinititems[bar[10]];
                    mapitems[2] = mapinititems[bar[11]];
                    x.push(0);
                    x.push(1);
                    y.push(0);
                    y.push(1);
                    z.push(0);
                    z.push(1);
                } else {
                    map[0][0] = bar[0];
                    map[0][1] = bar[0];
                    map[1][0] = bar[1];
                    map[1][1] = bar[1];
                    map[2][0] = bar[2];
                    map[2][1] = bar[3];
                    mapitems[0].push(bar[0]);
                    mapitems[0].push(bar[0]);
                    mapitems[1].push(bar[1]);
                    mapitems[1].push(bar[1]);
                    mapitems[2].push(bar[2]);
                    mapitems[2].push(bar[3]);
                    items.marker.color.push(items.z[items.z.length - 2]);
                    items.marker.color.push(items.z[items.z.length - 1]);
                }
            });
            var titles=[];
            {% for ab in staab %}
                titles.push("{{ab}}");
            {% endfor %}
            var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, scene : {xaxis:{title:titles[0],range : xbounds}, yaxis:{title:titles[1],range : ybounds}, zaxis:{title:titles[2],range : [0, 1]}}};
            trace = [items];
            Plotly.newPlot(container, trace, layout);
            var aes = [[1, 2, 3, 4], [1, 2, 3, 4], [1, 2, 3, 4], [1, 2, 3, 5]];
            var bes = [1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4];
            var ces = [1, 2, 3, 4, 2, 3, 4, 3, 3, 4, 3, 2, 4, 3, 2, 1];
            a = []; b = []; c = [];
            for (i = 0; i < 20; i++) {
                var a_ = Math.random();
                a.push(a_);
                var b_ = Math.random();
                b.push(b_);
                var c_ = Math.random();
                c.push(c_);
            }
            var dataessai = [{
                opacity:0.8,
                color:'rgb(200,100,300)',
                type: 'surface',
                z: aes,
            }];
        })
    }
}

function kdtreePlot3D(url, x, container, colormarker, colorline, fillcolor){
    loadAndPlot(url, function (data) {
        var items = {x:[], y:[], z:[], mode:'markers', type: 'scatter3d', marker: { size : 1, color: [] }, hoverinfo:'none' };
        var trace = [];
        var tracebis = [];
        var x = [];
        var y = [];
        var z = [];
        var map = [];
        var mapinit = [x, y, z];
        var mapitems = [items.x, items.y, items.z];
        var mapinititems = [items.x, items.y, items.z];
        var xstep, ystep, zstep;
        var xbounds = [];
        var ybounds = [];
        var zbounds = [];
        $.each(data, function(index, bar) {
            if (index == 0){
                xbounds.push(bar[0]);
                xbounds.push(bar[3]);
                ybounds.push(bar[1]);
                ybounds.push(bar[4]);
                zbounds.push(bar[2]);
                zbounds.push(bar[5]);
            } else {
                items.x.push(bar[0]);
                items.y.push(bar[1]);
                items.z.push(bar[2]);
                items.marker.color.push(items.z[items.z.length - 1]);
            }
        });
        var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, scene : {xaxis:{range : xbounds}, yaxis:{range : ybounds}, zaxis:{range : zbounds}}};
        trace = [items];
        Plotly.newPlot(container, trace, layout);
    })
}

function kdtreePlot(url, container, colormarker, colorline, fillcolor){
    loadAndPlot(url, function (data) {
        var items = {x:[], y:[], mode:'markers', type: 'scatter', marker: { size : 2, color: 'rgb(55, 128, 191)' }, hoverinfo:'none' };
        var trace = [];
        var tracebis = [];
        var xbounds = [];
        var ybounds = [];
        $.each(data, function(index, bar) {
            if (index > 0){
                items.x.push(bar[0]);
                items.y.push(bar[1]);
                tracebis.push(kdtreeRectangle(bar[2], bar[3], bar[4], bar[5], colorline, fillcolor));
            } else{
                xbounds.push(bar[0]);
                xbounds.push(bar[2]);
                ybounds.push(bar[1]);
                ybounds.push(bar[3]);
            }
        });
        var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, shapes : tracebis, xaxis:{title : '{{staab|first}}',range : xbounds}, yaxis:{title : '{{staab|last}}',range : ybounds}};
        trace = [items];
        Plotly.newPlot(container, trace, layout);
    })
}

function ShowAccurateSection(){
    ShowSliderValues()
    var i;
    var tab = document.getElementsByName('dimension');
    var tab2 = document.getElementsByName('sliders');
    var item;
    var tabtab = [];
    var ch = "";
    var index;
    var container = document.getElementById('viewPanel');
    for (i = 0; i < tab2.length; i++){
        tabtab.push(tab2[i].value);
    }
    ch = tabtab.join([separator = ',']);
    index = twoDsectionCoordinates.indexOf(ch);
    if (container.data.length - 1 >= 1){Plotly.deleteTraces(container, [container.data.length - 1]); }
    if (index == - 1){
        item = [];
    } else{
        item = twoDsections[index];
        item.marker.cmax = twoDsectionCmax;
        Plotly.addTraces(container, [item]);
    }
}

function newSection(){
    var items = {x:[], y:[], mode:'markers', type: 'scatter', marker: { size : 4, color: [], cmin : 0, cmax : 30}, hoverinfo:'none' };
    return items;
}

function ShowAxes(){
    document.getElementById('sectionSliders').innerHTML = "";
    document.getElementById('sliderValues').innerHTML = "";
    document.getElementById('viewPanel').innerHTML = "";
    var tab = document.getElementsByName('dimension');
    var tab2 = [];
    var j = tab.length;
    for (i = 0; i < tab.length; i++){
        if (tab[i].checked){
            j = j - 1;
        } else tab2.push(tab[i].value);
    }
    if (j < 2) {
        document.getElementById('sectionAxes').innerHTML = 'Too many selected directions';
    } else if (j == 2){
        document.getElementById('sectionAxes').innerHTML = ' Section axes : <input type="radio" name="dimensionsection" value="xsection" checked="checked" id="xsection" onchange="ShowSection(1)"/> <label for="xsection" name="labeldimensionsection">[' + tab2[0] + ',' + tab2[1] + ']</label><input type="radio" name="dimensionsection" value="ysection" id="ysection" onchange="ShowSection(-1)"/> <label for="ysection" name="labeldimensionsection" >[' + tab2[1] + ',' + tab2[0] + ']</label><br>';
        ShowSection(1);
    } else {
        document.getElementById('sectionAxes').innerHTML = 'Not enough selected directions';
    }
}
$("#viewPlotlyColorSectionUpdate").click(function(){
   x=document.getElementById('xsection');
   y=document.getElementById('ysection');
   if (x){
   if (x.checked) {
        ShowSection(1);
    }
   else if (y.checked) {
        ShowSection(-1);
    }
    }
});


$("#viewPlotlyColorSection").click(function(){
//    var x = document.getElementById('sectiondistanceppa').value;
    var x = document.getElementById('distanceppa').value;

    if (isNaN(x) || x == "%20" || x > 1000) {
        text = "Input not valid : " + x;
        document.getElementById('sectionDirections').innerHTML = text;
    } else {
        var chbis = "";
        var ch = "<form><fieldset><legend>2D-Sections according to  :</legend>(";
        var i = "";
        var ii = {{result.parameters.viabilityproblem.statevariables.count}} - 2;
        ch = ch + ii + " checkbox(es) must be checked)";
        {% for statevariable in staab %}
            chbis = chbis + "<input type='checkbox' name='dimension' value='{{statevariable}}' id='{{statevariable}}' onchange='ShowAxes()'/>{{statevariable}}";
        {% endfor %}
        document.getElementById('sectionAxes').innerHTML = "";
        ch = ch + chbis + "<fieldset></form>";
        document.getElementById('sectionAxes').innerHTML = "";
        document.getElementById('sectionSliders').innerHTML = "";
        document.getElementById('sliderValues').innerHTML = "";
        document.getElementById('viewPanel').innerHTML = "";
        document.getElementById('sectionDirections').innerHTML = ch;
    }
})

function ShowSliderValues(){
    var x = document.getElementById('distanceppa').value - 1;
    var i;
    var ii = 0;
    var tab2 = document.getElementsByName('sliders');
    var tab = document.getElementsByName('dimension');
    var ch = "";
    var j = tab.length;
    for (i = 0; i < tab.length; i++){
        if (tab[i].checked){
            ch = ch + tab[i].value + '= ' + (twoDsectionMins[i] + (twoDsectionMaxs[i] - twoDsectionMins[i]) * parseInt(tab2[ii].value) / x) + '  ';
            ii = ii + 1;
        }
    }
    document.getElementById('sliderValues').innerHTML = ch;
}

function ShowSection(transpose){
    var x = document.getElementById('distanceppa').value - 1;
    var tab = document.getElementsByName('dimension');
    var ch = "";
    var chbis = "";
    var permutstring = "";
    var permutstringbis = "";
    var indicesections = [];
    var j = tab.length;
    var i;
    for (i = 0; i < tab.length; i++){
        if (tab[i].checked){
            permutstring = permutstring + (i + 1);
        } else {
            if (transpose == 1){permutstringbis = permutstringbis + (i + 1); indicesections.push(i); }
            else {permutstringbis = (i + 1) + permutstringbis; indicesections.unshift(i); }
        }
    }
    permutstring = permutstring + permutstringbis;
    var xx = document.getElementById('distanceppa').value;
    var permutnumber = parseInt(permutstring);
    var url = "{% url 'sharekernel:ViNODistanceView' result.id 'NN' 'NNN' %}"
    url = url.replace("NNN", permutnumber);
    url = url.replace("NN", parseInt(xx));
    twoDsections = [];
    twoDsectionMins = [];
    twoDsectionMaxs = [];

    var currentIndex = '-1';
    var xbounds = [];
    var ybounds = [];
    var container = document.getElementById('viewPanel');
    loadAndPlot(url, function (data) {
        var items;
        items = newSection();
        var map = [];
        var mapinit = [items.x, items.y];
        $.each(data, function(index, bar) {
            if (index == 0){
                xbounds.push(bar[indicesections[0]]);
                xbounds.push(bar[tab.length + indicesections[0]]);
                ybounds.push(bar[indicesections[1]]);
                ybounds.push(bar[tab.length + indicesections[1]]);
                map.push(mapinit[bar[4]]);
                map.push(mapinit[bar[5]]);
                for (i = 0; i < tab.length; i++){
                    twoDsectionMins.push(bar[tab.length * 3 + i]);
                    twoDsectionMaxs.push(bar[tab.length * 4 + i]);
                }
            } else {
                if (bar[0] != currentIndex) {
                    if (currentIndex != '-1') {
                        twoDsections.push(items);
                    }
                    twoDsectionCoordinates.push(bar[0]);
                    items = newSection();
                    currentIndex = bar[0];
                }
                items.x.push(bar[1]);
                items.y.push(bar[2]);
                items.marker.color.push(bar[3]);
                if (twoDsectionCmax < bar[3]){twoDsectionCmax = bar[3]; }
            }
        });
        twoDsections.push(items);
        var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, xaxis:{title: tab[indicesections[0]].value,range : xbounds}, yaxis:{title: tab[indicesections[1]].value,range : ybounds}};
        Plotly.newPlot(container, [], layout);
        Plotly.addTraces(container, [{x:xbounds, y:ybounds, mode:'markers', type: 'scatter', marker: { size : 4, color: 'blue'}, hoverinfo:'none' }]);
        for (i = 0; i < tab.length; i++){
            if (tab[i].checked){
                ch = ch + tab[i].value + ' = ' + twoDsectionMins[i] + '  ';
                chbis = chbis + '<div id="slidemin' + tab[i].value + '">' + twoDsectionMins[i] + '</div>  <input type="range"  min="0" max="' + x + '" step="1" value="0" name="sliders" id="slide' + tab[i].value + '" onchange="ShowAccurateSection()"/><div id="slidemax' + tab[i].value + '">' + twoDsectionMaxs[i] + '</div>';
            }
        }

        document.getElementById('sectionSliders').innerHTML = chbis;
        document.getElementById('sliderValues').innerHTML = ch;
        ShowAccurateSection();
    });
}




function ShowSectionCoordinates(tabvalues){
    var tab = document.getElementsByName('dimensionsection');
    for (i = 0; i < tab.length; i++){
        tab[i].style.display = 'block';
        tab[i].checked = false;
    }
    tab = document.getElementsByName('labeldimensionsection');
    for (i = 0; i < tab.length; i++){
        tab[i].style.display = 'block';
        tab[i].innerHTML = tabvalues[i];
    }
}


$("#x").change(function(){
    var tabvalues = ['(y,z)', '(z,y)'];
    ShowSectionCoordinates(tabvalues);
})
$("#y").change(function(){
    var tabvalues = ['(x,z)', '(z,x)'];
    ShowSectionCoordinates(tabvalues);
})
$("#z").change(function(){
    var tabvalues = ['(x,y)', '(y,x)'];
    ShowSectionCoordinates(tabvalues);
})

function ViNOVisu(x){
     document.getElementById('viewPanelBW').innerHTML = "";
     var container = document.getElementById('viewPanelBW');
     var colormarker = 'rgb(255,0,0,0.4)';
     var colorline = 'rgba(128, 0, 128, 1)';
     var fillcolor = 'rgba(128, 0, 128, 0.7)';

    {% if result.parameters.viabilityproblem.statevariables.count == 2 %}
        var url = "{% url 'sharekernel:ViNOView2D' result.id 0 %}"
        {% if resultformat.title == 'bars' %}
            bargridPlot(url, x, container, colormarker, colorline, fillcolor);
        {% elif resultformat.title == 'kdtree' %}
            if (x>0){
                   bargridPlot(url, x, container, colormarker, colorline, fillcolor);
            }
            else kdtreePlot(url, container, colormarker, colorline, fillcolor);
        {% endif %}
    {% elif result.parameters.viabilityproblem.statevariables.count == 3 %}
            var url = "{% url 'sharekernel:ViNOView3D' result.id 0 %}"
        {% if resultformat.title == 'bars' %}
            bargridPlot3D(url, x, container, colormarker, colorline, fillcolor);
        {% elif resultformat.title == 'kdtree' %}
            if (x>0){
                   bargridPlot3D(url, x, container, colormarker, colorline, fillcolor);
            }
            else kdtreePlot3D(url, x, container, colormarker, colorline, fillcolor);
        {% endif %}
    {% endif %}
};

$("#viewPlotlyBW").click(function(){
       {% if result.parameters.viabilityproblem.statevariables.count == 2 %}
          var xmax = 5000;
       {% else %}
          var xmax = 300;
        {% endif %}
       if (document.getElementById("ppa").value > xmax){
           document.getElementById("ppa").value = xmax;
      }
      ViNOVisu(document.getElementById("ppa").value);
     });
$("#viewPlotlyBWOriginal").click(function(){ViNOVisu(0);});

function DistanceVinoVisu(x){

    var maxX = 500;
    {% if result.parameters.viabilityproblem.statevariables.count == 3 %}
        maxX = 150;
    {% endif %}
    var url = "{% url 'sharekernel:ViNODistanceView' result.id 'NN' 0%}"
    document.getElementById('viewPanel').innerHTML = "";
    // If x is Not a Number
    if (isNaN(x) || x == "%20" || x > 500) {
        text = "Input not valid : " + x;
        var container = document.getElementById('viewPanel');
        container.innerHTML = text;
    } else {
        url = url.replace("NN", x);
        loadAndPlot(url, function (data) {
            var container = document.getElementById('viewPanel');
            var map = [];
            var xbounds = [];
            var ybounds = [];
            {% if result.parameters.viabilityproblem.statevariables.count == 2 %}
                var items = {x:[], y:[], mode:'markers', type: 'scatter', marker: { size : 4, color: [] }, hoverinfo:'none' };
                var mapinit = [items.x, items.y];
                $.each(data, function(index, bar) {
                    if (index == 0){
                        xbounds.push(bar[0]);
                        xbounds.push(bar[2]);
                        ybounds.push(bar[1]);
                        ybounds.push(bar[3]);
                        map.push(mapinit[bar[4]]);
                        map.push(mapinit[bar[5]]);
                    }
                    else {
                        map[0].push(bar[0]);
                        map[1].push(bar[1]);
                        items.marker.color.push(bar[2]);
                    }
                });
                var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, xaxis:{title : "{{staab|first}}",range : xbounds}, yaxis:{title : "{{staab|last}}",range : ybounds}};
            {% elif result.parameters.viabilityproblem.statevariables.count == 3 %}
                var items = {x:[], y:[], z:[], mode:'markers', type: 'scatter3d', marker: { size : 1, color: [] }, hoverinfo:'none' };
                var zbounds = [];
                var mapinit = [items.x, items.y, items.z];
                $.each(data, function(index, bar) {
                    if (index == 0){
                        xbounds.push(bar[0]);
                        xbounds.push(bar[3]);
                        ybounds.push(bar[1]);
                        ybounds.push(bar[4]);
                        zbounds.push(bar[2]);
                        zbounds.push(bar[5]);
                        map.push(mapinit[bar[6]]);
                        map.push(mapinit[bar[7]]);
                        map.push(mapinit[bar[8]]);
                    } else {
                        map[0].push(bar[0]);
                        map[1].push(bar[1]);
                        map[2].push(bar[2]);
                        items.marker.color.push(bar[3]);
                    }
                });
                //                var layout = {showlegend: false,margin:{t:10},width: 600,height: 500,xaxis:{range : xbounds},yaxis:{range : ybounds}};
                var layout = {showlegend: false, margin:{t:10}, scene : {xaxis:{range : xbounds}, yaxis:{range : ybounds}, zaxis:{range: zbounds}}};
            {% endif %}
            Plotly.newPlot(container, [items], layout);
        })
    }

}

$("#viewPlotlyColor").click(function(){
    if (document.getElementById("distanceppa").value >500){
         document.getElementById("distanceppa").value = 500;
    }
    DistanceVinoVisu(document.getElementById("distanceppa").value);
    ViNOHisto(document.getElementById("maxvalue").value,document.getElementById("distanceppa").value);

});

function ViNOHisto(x,y){

    var url = "{% url 'sharekernel:ViNOHistogramDistance' result.id 'N' 'N' %}";
    var x, y, text;
    document.getElementById('histo').innerHTML = "";
    // Get the value of the input field with id="numb"
//    x = document.getElementById("maxvalue").value;
//    y = document.getElementById("distancehistoppa").value;
    // If x is Not a Number
    if (isNaN(x) || x == "%20" || isNaN(y) || y == "%20") {
        text = "Input not valid : " + y + " " + x;
        var container = document.getElementById('histo');
        container.innerHTML = text;
    } else {
        url = url.replace("N/N", y + "/" + x);
        var histogram = {x: [], y: [], type: 'bar', marker: {
        color: 'rgb(158,202,225)',
            opacity: 0.6,
            line: {
                color: 'rbg(8,48,107)',
                width: 1.5
            }
        }};
        var maxi = 0;
        var maxitrop = 0;
        var derniere;
        var ch = "1-";
        loadAndPlot(url, function (data) {
            $.each(data, function(index, bar) {
                if (index > 0){
                    if (index > 1){
                        ch += bar[0];
                        histogram.x.push(ch);
                        ch = "";
                        ch += bar[0] + '-';
                    }
                    histogram.y.push(bar[1]);
                    if (bar[1] > maxitrop){
                        maxi = maxitrop;
                        maxitrop = bar[1];
                    }
                    derniere = bar[1];
                }
            });
            ch = ch.replace("-", "");
            ch = '> ' + ch;
            histogram.x.push(ch);
            if (maxitrop == derniere){
                maxi = maxi + (maxitrop - maxi) / 10;
            } else maxi = maxitrop;
            var layout = {width: 600, height: 300, yaxis:{range : [0, maxi]}};
            Plotly.newPlot('histo', [histogram], layout);
        })
    }
}

$("#viewHisto").click(function(){

    if (document.getElementById("distanceppa").value >500){
         document.getElementById("distanceppa").value = 500;
    }

    ViNOHisto(document.getElementById("maxvalue").value,document.getElementById("distanceppa").value);
});

$("#viewHistoancien").click(function(){
    var url = "{% url 'sharekernel:ViNOHistogramDistance' result.id 'N' 'N' %}";
    var x, y, text;
    document.getElementById('histo').innerHTML = "";
    // Get the value of the input field with id="numb"
    x = document.getElementById("maxvalue").value;
    y = document.getElementById("distancehistoppa").value;
    // If x is Not a Number
    if (isNaN(x) || x == "%20" || isNaN(y) || y == "%20") {
        text = "Input not valid : " + y + " " + x;
        var container = document.getElementById('histo');
        container.innerHTML = text;
    } else {
        url = url.replace("N/N", y + "/" + x);
        var histogram = {x: [], y: [], type: 'bar', marker: {
        color: 'rgb(158,202,225)',
            opacity: 0.6,
            line: {
                color: 'rbg(8,48,107)',
                width: 1.5
            }
        }};
        var maxi = 0;
        var maxitrop = 0;
        var derniere;
        var ch = "1-";
        loadAndPlot(url, function (data) {
            $.each(data, function(index, bar) {
                if (index > 0){
                    if (index > 1){
                        ch += bar[0];
                        histogram.x.push(ch);
                        ch = "";
                        ch += bar[0] + '-';
                    }
                    histogram.y.push(bar[1]);
                    if (bar[1] > maxitrop){
                        maxi = maxitrop;
                        maxitrop = bar[1];
                    }
                    derniere = bar[1];
                }
            });
            ch = ch.replace("-", "");
            ch = '> ' + ch;
            histogram.x.push(ch);
            if (maxitrop == derniere){
                maxi = maxi + (maxitrop - maxi) / 10;
            } else maxi = maxitrop;
            var layout = {width: 600, height: 300, yaxis:{range : [0, maxi]}};
            Plotly.newPlot('histo', [histogram], layout);
        })
    }

});

function histodata(x, y) {
    /**** ch est une chaine qui va recevoir toutes les commandes HTML permettant mettre les valeurs de l'hitogrammme dans un tableau html************/
    var container = document.getElementById('histo');
    var max = x.length;
    var ch = "";
    ch += '<ul>';
    for (var i = 1; i < max; i++) { //dessin des barres
        ch += '<li>' + y[i] + ':' + x[i] + '</li>';
    }
    ch += '</ul>';
    container.innerHTML = ch;
}


function makeGraph() {
    var container = document.getElementById("histo");
    var labels = document.getElementById("labels");
    var dnl = container.getElementsByTagName("li");
    var maxvalue = 0;
    for (var i = 0; i < (dnl.length - 1); i++) {
        if (parseInt(dnl.item(i).innerHTML.split(":")[0]) > maxvalue){
            maxvalue = parseInt(dnl.item(i).innerHTML.split(":")[0]);
        }
    }
    labels.innerHTML = "<span style='margin:16px'></span>";
    if (maxvalue == 0) maxvalue = 200;
    for (i = 0; i < dnl.length; i++) {
        var item = dnl.item(i);
        var value = item.innerHTML;
        var content = value.split(":");
        value = content[0];
        item.innerHTML = value;
        if (parseInt(value) > maxvalue){
            value = maxvalue + 10;
            item.style.borderTop = "1px dotted white";
        }
        item.style.top = (199 - value * 200 / maxvalue) + "px";
        item.style.left = (i * 61 + 20) + "px";
        item.style.height = value * 200 / maxvalue + "px";
        item.style.width = 60 + "px";
        item.style.visibility = "visible";
        left = (i * 60 + 120) + "px";
        var ecart = "";
        if (parseInt(content[1]) < 10) ecart = "25";
        else if (parseInt(content[1]) < 100) ecart = "21";
        else if (parseInt(content[1]) < 1000) ecart = "16";
        else ecart = "10";
        labels.innerHTML = labels.innerHTML +
                "<span style='margin:" + ecart + "px'>" +
                content[1] + "</span>";
    }
}

</script>

{% endblock %}
