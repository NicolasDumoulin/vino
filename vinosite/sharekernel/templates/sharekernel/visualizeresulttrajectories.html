{% extends "base.html" %}

{% load staticfiles %}
{% block head %}
    <script src="{% static 'sharekernel/vinoplot.js' %}"></script>
    <script src="{% static 'sharekernel/vis.js' %}"></script>
    <script src="{% static 'sharekernel/plotly-latest.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'sharekernel/vis.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'sharekernel/histogram.css' %}" />

{% endblock %}

{% block body %}

<div id="container">
		<div id="row"><div class="col-sm-12">
<ol class="breadcrumb">
                    <li><a href="{% url 'sharekernel:home' %}">Home</a></li>
                    {% if category %}
                    <li><a href="{% url 'sharekernel:visitviabilityproblemlist'  category.id %}">{{category.text}}</a></li>
                    {% endif %}
                    <li><a href="{% url 'sharekernel:visitviabilityproblem'  viabilityproblem.id %}">{{viabilityproblem.title}}</a></li>
                    <li><a href="{% url 'sharekernel:visitresult'  result.id %}">{{result.title}}</a></li>
                </ol>
                    </div></div>
		  <div class="page-header">
<h2>Evolution visualisation  - Viable evolution building</h2>
                    </div>
    <div id="row"><div class="col-sm-2">
  <form class="form-horizontal">
    <div class="form-group">
      <label class="control-label col-sm-6" for="email"><p class="small">Using : </p></label>
      <div class="col-sm-6">
  <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">ViNO
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
              {% for r in results%}
      <li><a href="#">{{r.title}}</a></li>
		{% endfor %}
    </ul>
  </div>
      </div>
    </div>
    <div class="form-group">
      <label class="control-label col-sm-6" for="pwd"><p class="small">Integration method : </p></label>
      <div class="col-sm-6">     
  <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Euler
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
      <li><a href="#">Euler</a></li>

    </ul>
  </div>
     

      </div>
    </div>
    <div class="form-group">
      <label class="control-label col-sm-6" for="pwd"><p class="small">Integration time step : </p></label>
      <div class="col-sm-6">          
        <input type="password" class="form-control" id="timestep" placeholder="time step">
      </div>
    </div>

 <button type="button" class="btn btn-default btn-sm btn-block disabled">Complete evolution </button>
 <p class="small">by a viable one with caution threshold equal to :</p>   
    <div class="form-group">
      <label class="control-label col-sm-6" for="pwd"><p class="small">Caution threshold : </p></label>
      <div class="col-sm-6">          
        <input type="password" class="form-control" id="caution" placeholder="caution">
      </div>
    </div>

  <button type="button" class="btn btn-default btn-sm btn-block disabled">Complete evolution </button> <p class="small">by the closest viable one in terms of control values</p> 
  <button type="button" class="btn btn-default btn-sm btn-block " id="newev" onclick="addEvolution()">New evolution </button>  
<button type="button" class="btn btn-default btn-sm btn-block disabled">Copy evolution </button>
  <button type="button" class="btn btn-default btn-sm btn-block" onclick="deleteEvolution()">Delete evolution </button>
  </form>

                   </div>

    <div class="col-sm-10">
              <ul class="nav nav-pills" id="listev">
    
    <li class="active" id="lignetype"><a data-toggle="pill" id="menutype" href="#menu" onclick="changeActiveEvolution()">Evolution 1</a></li>
  </ul>
 <ul class="nav nav-tabs nav-justified">
  <li class="active"><a data-toggle="tab" href="#tevol">Time Evolution</a></li>
  <li class="disabled"><a data-toggle="tab" href="#menu1">Phase space</a></li>
</ul>

<div class="tab-content">
  <div id="tevol" class="tab-pane fade in active">
 <ul class="nav nav-tabs ">
  <li class="active"><a data-toggle="tab" href="#cstevol">Control and state Evolution</a></li>
  <li><a data-toggle="tab" href="#cadmstc">Control admissibilty and state constraints</a></li>
</ul>

<div class="tab-content">
  <div id="cstevol" class="tab-pane fade in active">


    <div id="row"><div class="col-sm-12">
            <form id="controlinputform" method="post" action="{% url 'sharekernel:controltostate' result.id %}">
            {% csrf_token %}
             <p id='controlinputtext'>
                  Starting point : 
              {% for ab in stateabbrevs%}
                   {{ab}} (0) : <input type="text" name="startingstate{{forloop.counter}}" id="startingstate{{forloop.counter}}" onKeyUp="return updatestateTrajectories()"/>
		{% endfor %}
		<br> Piecewise linear control functions -- <br>              
	      {% for ab in controlabbrevs%}
                   {{ab}}min : <input type="text" size = "3%" value = "-1" name="mincontrolinput{{forloop.counter}}" id="mincontrolinput{{forloop.counter}}" onKeyUp="return updateboundscontrolTrajectories({{forloop.counter}})"/>
                   {{ab}}max : <input type="text" size = "3%" value = "1" name="maxcontrolinput{{forloop.counter}}" id="maxcontrolinput{{forloop.counter}}" onKeyUp="return updateboundscontrolTrajectories({{forloop.counter}})"/>
                   {{ab}} : <input type="text" size = "70%" value="" name="controlinput{{forloop.counter}}" id="controlinput{{forloop.counter}}"  onKeyUp="return updateTrajectories({{forloop.counter}})"/><br>
		{% endfor %}
		Integration method : <SELECT name="method" size="1"><OPTION>Euler</SELECT>
                Integration time step :  <input type="text" name="dt" id="dt" size = "5%" onKeyUp="return updatestateTrajectories()"/>
                Time Horizon :  <input type="text" name="horizon" id="horizon" size = "5%" value="10" onKeyUp="return updateTrajectoriesHorizon()"/>
              </p>
            </form>

  </div>

</div>
    <div id="row"><div class="col-sm-6">
    <h3>Control Evolution</h3>
    <div id="info">Click on graph below to draw piecewise linear control functions : </div>        
    <div id="infobis">Clik on a graph point to remove it : </div>        
    <div id="controltrajectories" onmouseout= "erasepink();" onmousemove = "positioncurseur(event);" onclick = "addcursorpoint();"></div>

</div>
        <div class="col-sm-6">
<h3>State Evolution</h3>
            <div id="viewPanel"><div id="statetrajectories"></div></div>
        </div>
    </div>

  </div>
  <div id="cadmstc" class="tab-pane fade">


    <div id="row"><div class="col-sm-6">
    <h3>Control Admissibility</h3>
    <div id="checkcontroltrajectories"></div>

</div>
        <div class="col-sm-6">
<h3>State Constraint Satisfaction</h3>
            <div id="viewPanel"><div id="checkstatetrajectories"></div></div>
        </div>
    </div>


  </div>
</div> 

    
  </div>
  <div id="menu1" class="tab-pane fade">
    <h3>TODO</h3>
    <p>Todo.</p>
  </div>
</div> 
</div></div>



</div>

<script type="text/javascript">
    var evolutionnumber = 1;
    var evolutionactive = 0;

    var tabcolors = [        ['red','pink','lightgrey'],
                             ['rgba(255, 102, 51,1)','rgba(255, 204, 153,1)','lightgrey'], 
                             ['rgba(255, 255, 0,1)','rgba(255, 255, 153,1)','lightgrey'], 
                             ['rgba(51, 153, 51,1)','rgba(51, 204, 102,1)','lightgrey'], 
                             ['rgba(0, 102,255,1)','rgba(51, 204, 255,1)','lightgrey'] , 
                             ['rgba(153, 0,153,1)','rgba(204, 0, 204,1)','lightgrey'] , 
                             ['rgba(255, 51, 153,1)', 'rgba(255, 153, 255,1)','lightgrey'], 
                             ['rgba(153, 51, 0,1)','rgba(153, 102, 51,1)','lightgrey']
    ];

    function changeActiveEvolution(){
      setTimeout(changeActiveEvolutionbis, 200); }
    function changeActiveEvolutionbis(){

       var x = document.getElementById('listev');
       var i = x.children.length;
       for (j = 0; j < i; j++) {
          if ( x.children[j].className.match(/(?:^|\s)active(?!\S)/g) ){
          var indice = j;
    }}
       evolutionactive = indice;
      var container = document.getElementById("controltrajectories");
      var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;
      var controltraces =[];
      var ii=0;
	      {% for ab in controlabbrevs%}
                controltraces.push(container.data[rang+ii*2+1]);
                ii = ii+1;
		{% endfor %}
container = document.getElementById("statetrajectories");
       rang = {{viabilityproblem.statedimension}}*evolutionactive; 
      var statetraces =[];

       ii=0;
	      {% for ab in stateabbrevs%}
                statetraces.push(container.data[rang+ii]);
                ii = ii+1;
		{% endfor %}

      fromPlotlytoForm(controltraces,statetraces);
container = document.getElementById("controltrajectories");
     var update = {
        hoverinfo: 'none'
     };
     Plotly.restyle(container, update);
     update = {
        hoverinfo: 'x+y'
     };
      rang = {{viabilityproblem.controldimension}}*2*evolutionactive;
     var traceindices = [];
     ii = 0;
     	      {% for ab in controlabbrevs%}
                 traceindices.push(rang+2*ii+1);
                 ii = ii+1;
		{% endfor %}
             Plotly.restyle(container, update,traceindices);

   }
     function addEvolution(){
    if (evolutionnumber<8){
    var x = document.getElementById('listev');
    var i = x.children.length;
    for (j = 0; j < i; j++) {
    x.children[j].className =
   x.children[j].className.replace
      ( /(?:^|\s)active(?!\S)/g , '' )
    }
    var entry = document.getElementById('lignetype').cloneNode(false);
    entry.className += "active" 
    var entrychild = document.getElementById('menutype').cloneNode(true);
    evolutionnumber = evolutionnumber +1;
    entrychild.innerHTML = "Evolution "+evolutionnumber;
    entry.appendChild(entrychild);
    x.appendChild(entry);
    evolutionactive = i;

              var ii = 0;
	      var traces = [];
             {% for ab in controlabbrevs%}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: tabcolors[evolutionnumber-1][1] }, hoverinfo: 'none',yaxis: 'y'+(ii+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: tabcolors[evolutionnumber-1][0] }, hoverinfo: 'x+y',yaxis: 'y'+(ii+1) });
                 ii=ii+1
             {% endfor %}
         var container = document.getElementById("controltrajectories");
      var update = {
        hoverinfo: 'none'
     };
             Plotly.restyle(container, update);
	     Plotly.addTraces(container,traces);
             container = document.getElementById("statetrajectories");
                 ii = 0;
	      traces = [];
             {% for ab in stateabbrevs%}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(ii+1) });
                 ii=ii+1
             {% endfor %}
	     Plotly.addTraces(container,traces);

	      {% for ab in controlabbrevs%}
document.getElementById("controlinput{{forloop.counter}}").value = "";
		{% endfor %}

	      {% for ab in stateabbrevs%}
document.getElementById("startingstate{{forloop.counter}}").value = "";
		{% endfor %}

     }}

     function deleteEvolution(){
    var x = document.getElementById('listev');
    var i = x.children.length;
    if (i>1){
    for (j = 0; j < i; j++) {
     if ( x.children[j].className.match(/(?:^|\s)active(?!\S)/g) ){
      var indice = j;
    }}
    x.removeChild(x.children[indice]);
    x.children[0].className += "active";
    var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

    var traceindices = [];
    var ii = 0;
     	      {% for ab in controlabbrevs%}
                 traceindices.push(rang+ii*2);
                 traceindices.push(rang+ii*2+1);
                 ii = ii+1;
		{% endfor %}
      var container = document.getElementById("controltrajectories");
    Plotly.deleteTraces(container,traceindices);

    rang = {{viabilityproblem.statedimension}}*evolutionactive;
    traceindices = [];
    ii = 0;
     	      {% for ab in stateabbrevs%}
                 traceindices.push(rang+ii);
                 ii = ii+1;
		{% endfor %}
      container = document.getElementById("statetrajectories");
    Plotly.deleteTraces(container,traceindices);

    evolutionactive = 0;
container = document.getElementById("controltrajectories");
      var controltraces =[];
      var ii=0;
	      {% for ab in controlabbrevs%}
                controltraces.push(container.data[ii*2+1]);
                ii = ii+1;
		{% endfor %}
      var statetraces =[];
container = document.getElementById("statetrajectories");

       ii=0;
	      {% for ab in stateabbrevs%}
                statetraces.push(container.data[ii]);
                ii = ii+1;
		{% endfor %}

      fromPlotlytoForm(controltraces,statetraces);
container = document.getElementById("controltrajectories");

      var update = {
        hoverinfo: 'x+y'
     };
     traceindices = [];
    var ii = 0;
     	      {% for ab in controlabbrevs%}
                 traceindices.push(ii*2+1);
                 ii = ii+1;
		{% endfor %}
             Plotly.restyle(container, update,traceindices);

     }}

    function fromPlotlytoForm(controltraces,statetraces){
              var i=0;
	      {% for ab in controlabbrevs%}
                      var trace = controltraces[i];
                       var str = '';
                       for (j = 0; j < trace.x.length; j++) {
                          str= str+'('+trace.x[j]+','+trace.y[j]+')';
                    
                       }
                         
                       document.getElementById("controlinput{{forloop.counter}}").value = str;
                       i=i+1;
		{% endfor %}
                        if (statetraces[0].y.length>0){ 
              i=0;

	      {% for ab in stateabbrevs%}
                       document.getElementById("startingstate{{forloop.counter}}").value = statetraces[i].y[0];  
                       i=i+1;
		{% endfor %}
                        if (statetraces[0].x.length>1){ 
                 
                       var r = statetraces[0].x[1]-statetraces[0].x[0];
                       document.getElementById("dt").value=r.toFixed(2);}
                       else{
                       document.getElementById("dt").value = "1";

}
                   }
                   else {
	        i=0;
                {% for ab in stateabbrevs%}
                       document.getElementById("startingstate{{forloop.counter}}").value = "";
                       i=i+1;
		{% endfor %}
            }
    }

	      {% for ab in controlabbrevs%}
document.getElementById("controlinput{{forloop.counter}}").value = "";
		{% endfor %}

	      {% for ab in stateabbrevs%}
document.getElementById("startingstate{{forloop.counter}}").value = "";
		{% endfor %}
      var graphheight = 300;
      var gap = 0.05;
      var margin = 40;
      var graphwidth=500;
      var totalcontrolgraphwidth = graphwidth-2*margin;
      var totalcontrolgraphheight = graphheight*{{viabilityproblem.controldimension}}-2*margin;
      var plotheigh = (1-({{viabilityproblem.controldimension}}-1)*gap)/{{viabilityproblem.controldimension}};
      var plotheighplusgap = plotheigh+gap;
      initControlTrajPlot(10,gap,margin,graphheight,graphwidth,controltrajectories);
      initStateTrajPlot(10,gap,margin,graphheight,statetrajectories);
      initCheckStateTrajPlot(10,gap,margin,graphheight,checkstatetrajectories);

      document.getElementById("controltrajectories").on('plotly_click', function(data){

         var str = document.getElementById("infobis").innerHTML;
         var lx = parseFloat(str.split("(")[1]);
         var ly = parseFloat(str.split(",")[1]);
         var n = parseInt(str.split("plot")[1]);

           document.getElementById("infobis").innerHTML = 'Point ('+lx+','+ly+') removed from plot'+n;
         var control = document.getElementById('controlinput'+n);
         control.value = control.value.replace('('+lx+','+ly+')',''); 

         updateTrajectories(n);

	});


      document.getElementById("controltrajectories").on('plotly_hover', function(data){
              var lx = data.points[0].x;
              var ly = data.points[0].y;
             var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

              var number = data.points[0].curveNumber-rang;
              var n= (number-1)/2+1;
           document.getElementById("infobis").innerHTML = 'Click to remove point ('+lx+','+ly+') from plot '+n;

	});
      document.getElementById("controltrajectories").on('plotly_unhover', function(data){
           document.getElementById("infobis").innerHTML = 'Clik on a graph point to remove it :';

	});

      function initControlTrajPlot(maxtime,gap,margin,graphheight,graphwidth,container){
              var plotheighinpx = graphheight*{{viabilityproblem.controldimension}};
	      var layout = {paper_bgcolor: "#7f7f7f",plot_bgcolor: "#c7c7c7",autosize:false,showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin,pad:0},width: graphwidth,height: plotheighinpx,xaxis:{title : 't',range:[0,maxtime],domain: [0,1]},hovermode:'closest'};
              var plotheigh = (1-({{viabilityproblem.controldimension}}-1)*gap)/{{viabilityproblem.controldimension}};
              var i = 0;
	      var traces = [];
             {% for ab in controlabbrevs%}
                 init = i*(plotheigh+gap);
                 layout['yaxis'+(i+1)] = {title: '{{ab}}', range:[-1,1],domain:[init,init+plotheigh]}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'pink' }, hoverinfo: 'none',yaxis: 'y'+(i+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' }, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 i=i+1
             {% endfor %}
	     Plotly.newPlot(container,traces,layout);
//           document.getElementById("info").innerHTML =layout.yaxis1.title;
	}
      function initStateTrajPlot(maxtime,gap,margin,graphheight,container){
              var plotheighinpx = graphheight*{{viabilityproblem.statedimension}};
	      var layout = {showlegend: false,margin:{t:10,l:margin,r:10,b:margin},width: 500,height: plotheighinpx,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'};
              var plotheigh = (1-({{viabilityproblem.statedimension}}-1)*gap)/{{viabilityproblem.statedimension}};
              var i = 0;
	      var traces = [];
             {% for ab in stateabbrevs%}
                 init = i*(plotheigh+gap);
                 layout['yaxis'+(i+1)] = {title: '{{ab}}',domain:[init,init+plotheigh]}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 i=i+1
             {% endfor %}
	     Plotly.newPlot(container,traces,layout);
//           document.getElementById("info").innerHTML =layout.yaxis1.title;
	}

      function createAnnotation(){
              var annot = {x: 0.5,    xanchor: 'right',    y: 0,    yanchor: 'bottom',text:'yop',xref : 'paper',yref:'paper',showarrow : false};
     
        return annot;
     }
      function initCheckStateTrajPlot(maxtime,gap,margin,graphheight,container){
              var plotheighinpx = graphheight*{{ldescon}};

	      var layout = {annotations:[],showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin},width: 500,height: plotheighinpx,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'};
              var plotheigh = (1-({{ldescon}}-1)*gap)/{{ldescon}};
              var i = 0;
	      var traces = [];
             {% for ab in descon%}
                 init = i*(plotheigh+gap);
                 annot = createAnnotation();
                 annot.y = init+plotheigh;
                 annot.text = 'Condition : {{ab}}';
                 layout.annotations.push(annot);
                 layout['yaxis'+(i+1)] = {title: '',domain:[init,init+plotheigh]}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });

                 i=i+1
             {% endfor %}
	     Plotly.newPlot(container,traces,layout);
//           document.getElementById("info").innerHTML =layout.yaxis1.title;
	}

      function positioncurseuringraph(y){
        var newy = [-1];
        var ystar = y/(totalcontrolgraphheight*plotheighplusgap);
         var r =  ystar % 1;
         r = r*plotheighplusgap/plotheigh;
         r = r.toFixed(2);
//document.getElementById("info").innerHTML = r;
         if (r<= 1){
             newy[0] = r;
             newy.push({{viabilityproblem.controldimension}}-parseInt(ystar));
          }
        return newy;
      }
      function findPos(el) {
	var x = y = 0;
	if(el.offsetParent) {
		x = el.offsetLeft;
		y = el.offsetTop;
		while(el = el.offsetParent) {
			x += el.offsetLeft;
			y += el.offsetTop;
		}
	}
	return {'x':x, 'y':y};
      }

     function addcursorpoint(){
         var container = document.getElementById("controltrajectories");
         var str = document.getElementById("info").innerHTML;
         var lx = parseFloat(str.split("(")[1]);
         var ly = parseFloat(str.split(",")[1]);
         var n = parseInt(str.split("plot")[1]);
         var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

         var number = 2*(n-1)+rang;
         var lastt = 0;
         if (container.data[number+1].x.length>0){ lastt = container.data[number+1].x[container.data[number+1].x.length-1];} 
         if ((isNaN(lx)== false)&&(isNaN(ly)== false)&&(isNaN(n)== false)&&(lx>=lastt)){
           xnewpink = [lx];
           ynewpink = [ly];
           xnewred = container.data[number+1].x.concat([lx]);
           ynewred = container.data[number+1].y.concat([ly]);

           document.getElementById("info").innerHTML = 'Point ('+lx+','+ly+') added to plot'+n;

         var control = document.getElementById('controlinput'+n);
         control.value = control.value+'('+lx+','+ly+')'; 
         updateTrajectories(n);

       }
else{
//           document.getElementById("info").innerHTML = 'Merde';

}
     }

      function erasepink(){
         var container = document.getElementById("controltrajectories");
         var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

               for(i = 0;i<{{viabilityproblem.controldimension}};i++){
                 if (container.data[rang+2*i].x.length >1 ){

                  update = {x:[[container.data[rang+2*i].x[0]]],y:[[container.data[rang+2*i].y[0]]]}
//                var update = {x:[[0,9]],y:[[1,1]]};

		Plotly.restyle(container,update,[rang+2*i]);
                }
             }
     }
     function positioncurseur(event){
         var container = document.getElementById("controltrajectories");
         var pos = findPos(container);
         var px = event.pageX-pos.x-margin;
         var py = event.pageY-pos.y-margin;
         var sition = positioncurseuringraph(py);
         py = sition[0];

         if ((py>=0)&&(px>=0)&&(px<=totalcontrolgraphwidth)){
            var ny = sition[1];
            var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

            var number = 2*(ny-1)+rang;

             if (ny>1){
               var str = 'yaxis'+sition[1];
             }
             else{
               var str = 'yaxis';
             }
             var range = container.layout[str].range;
             var ly = range[1]-py*(range[1]-range[0]);
             range = container.layout['xaxis'].range;
             var lx = px/totalcontrolgraphwidth;
             lx = lx.toFixed(2);
             lx = lx*range[1];
             lx = lx.toFixed(2);
             ly = ly.toFixed(2);

//             py = container.data[0].xaxis.p2l(py);
             document.getElementById("info").innerHTML = 'Add point ('+lx+','+ly+') to plot'+sition[1];

             if (container.data[number].x.length >0 ){
                var update = {x:[[container.data[number].x[0],lx]],y:[[container.data[number].y[0],ly]]}
//                var update = {x:[[0,9]],y:[[1,1]]};

		Plotly.restyle(container,update,[number]);

             }
       }
       else {
             erasepink();
             document.getElementById("info").innerHTML = 'Click on graph below to draw piecewise linear control functions : ';

       } 
     }

      function arecorrects(){
        var b = true;      
        if ((isNaN(parseFloat(document.getElementById('horizon').value))) || (isNaN(parseFloat(document.getElementById('dt').value))) ||(parseFloat(document.getElementById('horizon').value) <=0)||(parseFloat(document.getElementById('dt').value) <=0)){ b = false;}
        if (b == true){
        for (var i = 1;i<={{viabilityproblem.statedimension}};i++) {
           if (isNaN(parseFloat(document.getElementById('startingstate'+i).value))) {b = false;}
        }
        }
//        document.getElementById("info").innerHTML = b;
        return b;
      }

      function iscorrect(str){
        var tab = [];
        var t = [];
        var u = [];  
        var b = true;
        if (str != ""){
          if (str[0] != '('){
 	      b = false;
//              document.getElementById("essai").innerHTML = "error1";
}
          else if (str[str.length-1] != ')'){
 	      b = false;
//              document.getElementById("essai").innerHTML = "error2"+str[str.length-1];
}
          else { 
               donnees = str.split(")(");
               donnees[0] = donnees[0].replace("(","");
               donnees[donnees.length-1] = donnees[donnees.length-1].replace(")","");
              lasttimevalue = 0;
              for (var i = 0;i< donnees.length;i++) {
		dd = donnees[i].split(",");
		if (dd.length != 2){ b = false; //document.getElementById("essai").innerHTML = donnees[i];
                }
                else if (isNaN(parseFloat(dd[0]))){b = false;//document.getElementById("essai").innerHTML = dd[0];
                }
                else if (parseFloat(dd[0]) < lasttimevalue){b = false;//document.getElementById("essai").innerHTML = dd[0];
                }
                else if (isNaN(parseFloat(dd[1]))){b = false;//document.getElementById("essai").innerHTML = dd[1];
                 }
                else{
                     lasttimevalue = parseFloat(dd[0]);
		     t.push(dd[0]);
		     u.push(dd[1]);
	
                }
	   } 
	 }
       }
       tab.push(b);
       tab.push(t);
       tab.push(u);

          return tab;
      }


      function updateboundscontrolTrajectories(number){
        minu = parseFloat(document.getElementById("mincontrolinput"+number).value);
        maxu = parseFloat(document.getElementById("maxcontrolinput"+number).value);

        if ((isNaN(minu) == false)&&(isNaN(maxu) == false)&&(minu<maxu)){
        var update = {yaxis:{range : [minu,maxu]}};
        Plotly.relayout(controltrajectories, update)
        }
      }


      function updateTrajectoriesHorizon(){
        var horizon =  parseFloat(document.getElementById("horizon").value);
        if (isNaN(horizon) == false){
        var update = {xaxis:{range : [0,horizon]}};
        Plotly.relayout(controltrajectories, update)
        Plotly.relayout(statetrajectories, update)
       }
      }

      function updatecontrolTrajectories(number){
          var tab = iscorrect(document.getElementById("controlinput"+number+"").value);
          if (tab[0] == true) {
              var containerTraj = document.getElementById('controltrajectories');
              if (tab[1].length>0) {
		xnew = [tab[1][tab[1].length-1]];
                ynew = [tab[2][tab[1].length-1]];
	      }
              else{
		xnew = [];
                ynew = [];

	      } 	
             var update = {x: [xnew,tab[1]],y:[ynew,tab[2]]};
             var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;
//document.getElementById("info").innerHTML = "popo";
             Plotly.restyle(containerTraj, update, [rang+(number-1)*2,rang+(number-1)*2+1])
        }
      }

      function updateTrajectories(number){
             updatecontrolTrajectories(number);
             updatestateTrajectories();
      }

        function loadAndPlotbis(url,formdata,callback) {
            $.ajax({ url: url,
                    type: "POST",
                    data: formdata,
                    processData: false,
                    contentType: false,
                    dataType:"json",
                    success: callback,
                    complete: function(){
		}
            })
            return false;
        }


      function updatestateTrajectories(){
          var b = true;
          for (var i=1;i<={{viabilityproblem.controldimension}};i++){b = b && iscorrect(document.getElementById("controlinput"+i+"").value)[0];}
          if (b == true) {
              if (arecorrects()){
                var form = document.getElementById('controlinputform');
                var formdata = new FormData(form);
                var url = "{% url 'sharekernel:controltostate' result.id%}"
		var container = document.getElementById('controltrajectories');
		var containerbis = document.getElementById('checkstatetrajectories');
                var rang = {{viabilityproblem.statedimension}}*evolutionactive;
                var colori = container.data[rang+1].marker.color;
                for (i=0;i<tabcolors.length;i++){
                 if( tabcolors[i].indexOf(colori)!=-1){
                        indice = i;

                     }
                }

                container = document.getElementById('statetrajectories');
                loadAndPlotbis(url,formdata,function(data){
                      $.each(data, function(index,bar) {
                        if (index == 0){
			    color = bar;
                           for ( i=0;i<color.length;i++){
                             color[i] = tabcolors[indice][2-color[i]];
                          }
                        }
                        else if(index == 1){
			    times = bar;
                        } 
                        else if (index<{{viabilityproblem.statedimension}}+2){
			    container.data[rang+index-2].x = times;
			    container.data[rang+index-2].y = bar;
			    container.data[rang+index-2].marker.color = color;

                        }
                        else {
                            rang = {{ldescon}}*2*evolutionactive;
 			    containerbis.data[rang+index-2-{{viabilityproblem.statedimension}}].x = times;
			    containerbis.data[rang+index-2-{{viabilityproblem.statedimension}}].y = bar;

                        }



			})	

			Plotly.redraw(container);
			Plotly.redraw(containerbis);

                });
              }
        }
      }

</script>    
{% endblock %}
