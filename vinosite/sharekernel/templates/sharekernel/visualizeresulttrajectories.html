{% extends "base.html" %}

{% load staticfiles %}
{% block head %}
    <script src="{% static 'sharekernel/vinoplot.js' %}"></script>
    <script src="{% static 'sharekernel/vis.js' %}"></script>
    <script src="{% static 'sharekernel/plotly-latest.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'sharekernel/vis.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'sharekernel/histogram.css' %}" />

{% endblock %}

{% block body %}

<div id="container">
		<div id="row"><div class="col-sm-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'sharekernel:home' %}">Home</a></li>
                    <li><a href="{% url 'sharekernel:visitviabilityproblem'  viabilityproblem.id %}">{{viabilityproblem.title}}</a></li>
                    <li><a href="{% url 'sharekernel:visitresult'  result.id %}">{{result.title}}</a></li>
                </ol>
                </div></div>
	<div class="page-header">

	</div>



  <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#home">		<h2>Evolution design</h2>   
		<button type="button" class="btn btn-default btn-sm " id="newev" onclick="addEvolution()">Add an evolution </button>  
			<button type="button" class="btn btn-default btn-sm disabled">Copy active evolution </button>
			<button type="button" class="btn btn-default btn-sm " onclick="deleteEvolution()">Delete active evolution </button>
</a></li>
    <li><a data-toggle="tab" href="#menu1"><h2>View all evolutions</h2></a></li>
  </ul>


  <div class="tab-content">
    <div id="home" class="tab-pane fade in active">




	<div id="row"><div class="col-sm-12">
		<ul class="nav nav-pills" id="listev">
			<li class="active" id="lignetype"><a data-toggle="pill" id="menutype" href="#menu" onclick="changeActiveEvolution()">Evolution 1</a></li>
		</ul>

	</div></div>

	<div id="row"><div class="col-sm-12">
		 <div class="panel-group">
		 <form id="controlinputform" method="post" action="{% url 'sharekernel:controltostate' result.id %}">
            			{% csrf_token %}

		  <div class="panel panel-default">

		    <div class="panel-heading">
		      <h4 class="panel-title">
			<a data-toggle="collapse" href="#collapse1"><span class="glyphicon glyphicon-collapse-down"></span> Evolution specifications</a>
		      </h4>

		    </div>

		    <div id="collapse1" class="panel-collapse collapse">
		      <ul class="list-group">
			<li class="list-group-item">Dynamic parameter values: <SELECT name="pvalues" size="1"><OPTION>TODO</SELECT></li>
			<li class="list-group-item">				Integration method : <SELECT name="method" size="1"><OPTION>Euler</SELECT>
                		Integration time step :  <input type="text" name="dt" id="dt" size = "5%" onKeyUp="return updatestateTrajectories()"/>
                		Time Horizon :  <input type="text" name="horizon" id="horizon" size = "5%" value="10" onKeyUp="return updateTrajectoriesHorizon()"/>

			</li>
			<li class="list-group-item">                  		Initial point : 
              			{% for ab in stateabbrevs%}
                   		{{ab}}  : <input type="text" name="startingstate{{forloop.counter}}" id="startingstate{{forloop.counter}}" onKeyUp="return updatestateTrajectories()"/>
				{% endfor %}
			</li>
			<li class="list-group-item">       				 Piecewise linear control functions -- <br>              
	      			{% for ab in controlabbrevs%}
                   		{{ab}} : <input type="text" size = "70%" value="" name="controlinput{{forloop.counter}}" id="controlinput{{forloop.counter}}"  onKeyUp="return updateTrajectories({{forloop.counter}})"/><br>
				{% endfor %}

			</li>
			<li class="list-group-item">
    <div class="row">
  <div id="infonew">Click on graph below to draw piecewise linear control functions : </div>        
    <div id="infobisnew">Clik on a graph point to remove it : </div>
            {% for ab in controlabbrevs%}
                <div class="col-sm-4"><div name="allcontroltrajectories" id="controltrajectories{{forloop.counter}}" onmouseout= "erasepinkNew(this);" onmousemove = "positioncurseurNew(this,event);" onclick = "addcursorpointNew(this);"></div></div>
             {% endfor %}
    </div>
			</li>
			<li class="list-group-item">Associated ViNO: <SELECT name="hiddenvino" size="1"><OPTION>TODO</SELECT>Norm : <SELECT name="hiddennorm" id="hiddennorm" size="1"><OPTION>Sup Norm</SELECT>	      		
	{% for ab in controlabbrevs%}
                   		{{ab}} step: <input type="text" size = "10%" value="" name="hiddencontrolstep{{forloop.counter}}" id="hiddencontrolstep{{forloop.counter}}"/><br>
				{% endfor %}
</li>

		      </ul>
		      <div class="panel-footer"><a href="javascript:void(0);" onclick="$('#collapse1').collapse('hide')"><span class="glyphicon glyphicon-collapse-up" >Close</span></a></div>

		    </div>

		  </div>
		  </form>
		</div>
		 <div class="panel-group">
		  <div class="panel panel-default">
		    <div class="panel-heading">
		      <h4 class="panel-title">
			<a data-toggle="collapse" href="#collapse2"><span class="glyphicon glyphicon-collapse-down"></span> State Evolution</a>
		      </h4>
		    </div>
		    <div id="collapse2" class="panel-collapse collapse">
		      <ul class="list-group">
			<li class="list-group-item"> 	
     <div class="row">
  
             {% for ab in stateabbrevs%}
                <div class="col-sm-4"><div id="statetrajectories{{forloop.counter}}"></div></div>
             {% endfor %}
</div>
			</li>
		      </ul>
		      <div class="panel-footer"><a href="javascript:void(0);" onclick="$('#collapse2').collapse('hide')"><span class="glyphicon glyphicon-collapse-up" >Close</span></a></div>
		    </div>
		  </div>
		</div>

 <div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse3"><span class="glyphicon glyphicon-collapse-down"></span> Control Admissibility</a>
      </h4>
    </div>
    <div id="collapse3" class="panel-collapse collapse">
      <div class="panel-body"><div id="checkcontroltrajectories"></div>TODO</div>
      <div class="panel-footer"><a href="javascript:void(0);" onclick="$('#collapse3').collapse('hide')"><span class="glyphicon glyphicon-collapse-up" >Close</span></a></div>
    </div>
  </div>
</div>
<div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse4"><span class="glyphicon glyphicon-collapse-down"></span> Constraint Satisfaction</a>
      </h4>
    </div>
    <div id="collapse4" class="panel-collapse collapse">
      <div class="panel-body">     <div class="row">
  
             {% for ab in descon%}
                <div class="col-sm-4"><div id="checkstatetrajectories{{forloop.counter}}"></div></div>
             {% endfor %}
</div>
</div>
      <div class="panel-footer"><a href="javascript:void(0);" onclick="$('#collapse4').collapse('hide')"><span class="glyphicon glyphicon-collapse-up" >Close</span></div>
    </div>
  </div>
</div>

<div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse6"><span class="glyphicon glyphicon-collapse-down"></span> 2D-sections of the state space</a>
      </h4>
    </div>
    <div id="collapse6" class="panel-collapse collapse">
      <ul class="list-group">
        <li class="list-group-item">  
    <div class="row">
  
             {% for ab in stateabbrevs%}
             {% for ab in stateabbrevs%}
             {% if  forloop.counter != forloop.parentloop.counter %}

                <div class="col-sm-4"><div id="2Dstatetrajectories{{forloop.parentloop.counter}}{{forloop.counter}}"></div></div>
             {% endif %}

             {% endfor %}
             {% endfor %}
</div>
</li>
        <li class="list-group-item">  
{% if viabilityproblem.statedimension == 2%}
<button id="viewPlotlyBW" class="btn btn-primary">View Vino</button> with <input type="text"  id="ppa" value="50"> ppa
<button id="deletePlotlyBW" class="btn btn-primary">Delete Vino</button>
{% endif %}

</li>
</ul>

      <div class="panel-footer"><a href="javascript:void(0);" onclick="$('#collapse6').collapse('hide')"><span class="glyphicon glyphicon-collapse-up" >Close</span></a>          
</div>
    </div>
  </div>
</div>


 <div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse5"><span class="glyphicon glyphicon-collapse-down"></span> Making the evolution viable</a>
      </h4>
    </div>
    <div id="collapse5" class="panel-collapse collapse">
      <ul class="list-group">
        <li class="list-group-item">  
      Using : 
  <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">ViNO
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
              {% for r in results%}
      <li><a href="#">{{r.title}}</a></li>
		{% endfor %}
    </ul>
  </div>
      
  </li>
        <li class="list-group-item"> <button type="button" class="btn btn-default btn-sm disabled">Complete evolution </button>
 <p class="small">by a viable one with caution threshold equal to :</p>   
      <label class="control-label " for="pwd"><p class="small">Caution threshold : </p></label>
                
        <input type="text"  id="caution" placeholder="caution">
      
    
</li>
        <li class="list-group-item">  <button type="button" class="btn btn-default btn-sm" onclick="makeViableTrajectories();">Complete evolution </button> <p class="small">by the closest viable one in terms of control values</p> 
Norm : <SELECT name="norm" id ="norm" size="1"><OPTION>Sup Norm</SELECT>	      		
	{% for ab in controlabbrevs%}
                   		{{ab}} step: <input type="text" size = "10%" value="" name="controlstep{{forloop.counter}}" id="controlstep{{forloop.counter}}" onKeyUp="return hiddencopy(this,{{forloop.counter}})"/><br>
				{% endfor %}

</li>
      </ul>
      <div class="panel-footer"><a href="javascript:void(0);" onclick="$('#collapse5').collapse('hide')"><span class="glyphicon glyphicon-collapse-up" >Close</span></a></div>
    </div>
  </div>
</div>
	</div></div>

    </div>


    <div id="menu1" class="tab-pane fade">
<div id="info">Click on graph below to draw piecewise linear control functions : </div>        
    <div id="infobis">Clik on a graph point to remove it : </div>        
    <div id="controltrajectories" onmouseout= "erasepink();" onmousemove = "positioncurseur(event);" onclick = "addcursorpoint();"></div>
<div id="viewPanel"><div id="statetrajectories"></div><div id="checkstatetrajectories"></div>
</div>

    </div>
  </div>
</div>			            


<script type="text/javascript">


  
      function hiddencopy(me,n){
          document.getElementById("hiddennorm").selectedIndex;
          document.getElementById("norm").selectedIndex; 

          document.getElementById("hiddencontrolstep"+n).value = me.value;
	}

      function init2DstateTrajPlotNew(maxtime,margin){
              var container;
             {% for ab in stateabbrevs%}
             {% for abb in stateabbrevs%}
             {% if  forloop.counter != forloop.parentloop.counter %}
                 container = document.getElementById("2Dstatetrajectories{{forloop.parentloop.counter}}{{forloop.counter}}");
         	 Plotly.newPlot(container,[{x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' }, hoverinfo: 'x+y' }],{yaxis:{title: '{{abb}}'},showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin,pad:0},width: 400,height: 300,xaxis:{title : '{{ab}}'},hovermode:'closest'});
             {% endif %}
             {% endfor %}
             {% endfor %}
	}
      init2DstateTrajPlotNew(10,40);
      function initControlTrajPlotNew(maxtime,margin){
              var container;
             {% for ab in controlabbrevs%}
                 container = document.getElementById("controltrajectories{{forloop.counter}}");
         	 Plotly.newPlot(container,[{x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'pink' }, hoverinfo: 'none'},{x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' }, hoverinfo: 'x+y' }],{yaxis:{title: '{{ab}}', range:[-1,1]},paper_bgcolor: "#7f7f7f",plot_bgcolor: "#c7c7c7",autosize:false,showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin,pad:0},width: 400,height: 300,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'});
             {% endfor %}
	}

      initControlTrajPlotNew(10,40);
      function initCheckStateTrajPlotNew(maxtime,margin){
              var container;
             {% for ab in descon%}
                 container = document.getElementById("checkstatetrajectories{{forloop.counter}}");
        	 Plotly.newPlot(container,[{x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y' },{x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y' }],{title: 'Condition : {{ab}}',annotations:[],showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin},width: 400,height:300,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'});
             {% endfor %}
	}
      initCheckStateTrajPlotNew(10,40);
      function initStateTrajPlotNew(maxtime,margin){
              var container;
             {% for ab in stateabbrevs%}
                 container = document.getElementById("statetrajectories{{forloop.counter}}");
        	 Plotly.newPlot(container,[{x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y' }],{yaxis: {title: '{{ab}}'},showlegend: false,margin:{t:10,l:margin,r:10,b:margin},width: 400,height: 300,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'});
             {% endfor %}
	}

      initStateTrajPlotNew(10,40);
    var evolutionnumber = 1;
    var evolutionactive = 0;

    var tabcolors = [        ['red','pink','lightgrey'],
                             ['rgba(255, 102, 51,1)','rgba(255, 204, 153,1)','lightgrey'], 
                             ['rgba(255, 255, 0,1)','rgba(255, 255, 153,1)','lightgrey'], 
                             ['rgba(51, 153, 51,1)','rgba(51, 204, 102,1)','lightgrey'], 
                             ['rgba(0, 102,255,1)','rgba(51, 204, 255,1)','lightgrey'] , 
                             ['rgba(153, 0,153,1)','rgba(204, 0, 204,1)','lightgrey'] , 
                             ['rgba(255, 51, 153,1)', 'rgba(255, 153, 255,1)','lightgrey'], 
                             ['rgba(153, 51, 0,1)','rgba(153, 102, 51,1)','lightgrey']
    ];

    function changeActiveEvolution(){
      setTimeout(changeActiveEvolutionbis, 200); }
    function changeActiveEvolutionbis(){

       var x = document.getElementById('listev');
       var i = x.children.length;
       for (j = 0; j < i; j++) {
          if ( x.children[j].className.match(/(?:^|\s)active(?!\S)/g) ){
          var indice = j;
    }}
       evolutionactive = indice;
      var container = document.getElementById("controltrajectories");
      var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;
      var controltraces =[];
      var ii=0;
	      {% for ab in controlabbrevs%}
                controltraces.push(container.data[rang+ii*2+1]);
                ii = ii+1;
		{% endfor %}
container = document.getElementById("statetrajectories");
       rang = {{viabilityproblem.statedimension}}*evolutionactive; 
      var statetraces =[];

       ii=0;
	      {% for ab in stateabbrevs%}
                statetraces.push(container.data[rang+ii]);
                ii = ii+1;
		{% endfor %}
container = document.getElementById("checkstatetrajectories");
       rang = 2*{{ldescon}}*evolutionactive; 
      var checkstatetraces =[];

       ii=0;
	      {% for ab in descon%}
                checkstatetraces.push(container.data[rang+2*ii]);
                checkstatetraces.push(container.data[rang+2*ii+1]);

                ii = ii+1;
		{% endfor %}

      fromPlotlytoForm(controltraces,statetraces,checkstatetraces);
container = document.getElementById("controltrajectories");
     var update = {
        hoverinfo: 'none'
     };
     Plotly.restyle(container, update);
     update = {
        hoverinfo: 'x+y'
     };
      rang = {{viabilityproblem.controldimension}}*2*evolutionactive;
     var traceindices = [];
     ii = 0;
     	      {% for ab in controlabbrevs%}
                 traceindices.push(rang+2*ii+1);
                 ii = ii+1;
		{% endfor %}
             Plotly.restyle(container, update,traceindices);

   }
     function addEvolution(){
    if (evolutionnumber<8){
    var x = document.getElementById('listev');
    var i = x.children.length;
    for (j = 0; j < i; j++) {
    x.children[j].className =
   x.children[j].className.replace
      ( /(?:^|\s)active(?!\S)/g , '' )
    }
    var entry = document.getElementById('lignetype').cloneNode(false);
    entry.className += "active" 
    var entrychild = document.getElementById('menutype').cloneNode(true);
    evolutionnumber = evolutionnumber +1;
    entrychild.innerHTML = "Evolution "+evolutionnumber;
    entry.appendChild(entrychild);
    x.appendChild(entry);
    evolutionactive = i;

              var ii = 0;
	      var traces = [];
             {% for ab in controlabbrevs%}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: tabcolors[evolutionnumber-1][1] }, hoverinfo: 'none',yaxis: 'y'+(ii+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: tabcolors[evolutionnumber-1][0] }, hoverinfo: 'x+y',yaxis: 'y'+(ii+1) });
                 ii=ii+1
             {% endfor %}
         var container = document.getElementById("controltrajectories");
         var containerbis = document.getElementById("checkstatetrajectories");

      var update = {
        hoverinfo: 'none'
     };
             Plotly.restyle(container, update);
	     Plotly.addTraces(container,traces);
             container = document.getElementById("statetrajectories");
                 ii = 0;
	      traces = [];
             {% for ab in stateabbrevs%}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(ii+1) });
                 ii=ii+1;
             {% endfor %}
	     Plotly.addTraces(container,traces);

             i =0;
             traces = [];
             {% for ab in descon%}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });

                 i=i+1
             {% endfor %}
	     Plotly.addTraces(containerbis,traces);

	      {% for ab in controlabbrevs%}
document.getElementById("controlinput{{forloop.counter}}").value = "";
                      Plotly.restyle(document.getElementById("controltrajectories{{forloop.counter}}"),{x:[[],[]],y:[[],[]]},[1,0]);

		{% endfor %}

	      {% for ab in stateabbrevs%}
document.getElementById("startingstate{{forloop.counter}}").value = "";
                      Plotly.restyle(document.getElementById("statetrajectories{{forloop.counter}}"),{x:[[]],y:[[]]},[0]);

		{% endfor %}

	      {% for ab in descon%}
                      Plotly.restyle(document.getElementById("checkstatetrajectories{{forloop.counter}}"),{x:[[],[]],y:[[],[]]},[0,1]);

		{% endfor %}

     }}

     function deleteEvolution(){
    var x = document.getElementById('listev');
    var i = x.children.length;
    if (i>1){
    for (j = 0; j < i; j++) {
     if ( x.children[j].className.match(/(?:^|\s)active(?!\S)/g) ){
      var indice = j;
    }}
    x.removeChild(x.children[indice]);
    x.children[0].className += "active";
    var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

    var traceindices = [];
    var ii = 0;
     	      {% for ab in controlabbrevs%}
                 traceindices.push(rang+ii*2);
                 traceindices.push(rang+ii*2+1);
                 ii = ii+1;
		{% endfor %}
      var container = document.getElementById("controltrajectories");
    Plotly.deleteTraces(container,traceindices);

    rang = {{viabilityproblem.statedimension}}*evolutionactive;
    traceindices = [];
    ii = 0;
     	      {% for ab in stateabbrevs%}
                 traceindices.push(rang+ii);
                 ii = ii+1;
		{% endfor %}
      container = document.getElementById("statetrajectories");
    Plotly.deleteTraces(container,traceindices);

    evolutionactive = 0;
container = document.getElementById("controltrajectories");
      var controltraces =[];
      var ii=0;
	      {% for ab in controlabbrevs%}
                controltraces.push(container.data[ii*2+1]);
                ii = ii+1;
		{% endfor %}
      var statetraces =[];
container = document.getElementById("statetrajectories");

       ii=0;
	      {% for ab in stateabbrevs%}
                statetraces.push(container.data[ii]);
                ii = ii+1;
		{% endfor %}
container = document.getElementById("checkstatetrajectories");
      var checkstatetraces =[];

       ii=0;
	      {% for ab in descon%}
                checkstatetraces.push(container.data[2*ii]);
                checkstatetraces.push(container.data[2*ii+1]);

                ii = ii+1;
		{% endfor %}

      fromPlotlytoForm(controltraces,statetraces,checkstatetraces);
container = document.getElementById("controltrajectories");

      var update = {
        hoverinfo: 'x+y'
     };
     traceindices = [];
    var ii = 0;
     	      {% for ab in controlabbrevs%}
                 traceindices.push(ii*2+1);
                 ii = ii+1;
		{% endfor %}
             Plotly.restyle(container, update,traceindices);

     }}

    function fromPlotlytoForm(controltraces,statetraces,checkstatetraces){
              var i=0;
	      {% for ab in controlabbrevs%}
                      var trace = controltraces[i];
                       var str = '';
                       for (j = 0; j < trace.x.length; j++) {
                          str= str+'('+trace.x[j]+','+trace.y[j]+')';
                    
                       }
                         
                       document.getElementById("controlinput{{forloop.counter}}").value = str;

//                  update = {x:[[container.data[0].x[0]]],y:[[container.data[0].y[0]]]}
                     if (trace.x.length>0){
             	       Plotly.restyle(document.getElementById("controltrajectories{{forloop.counter}}"),{x:[trace.x,[trace.x[trace.x.length-1]]],y:[trace.y,[trace.y[trace.y.length-1]]]},[1,0]);
                     }
                     else{
                      Plotly.restyle(document.getElementById("controltrajectories{{forloop.counter}}"),{x:[[],[]],y:[[],[]]},[1,0]);

} 
                       i=i+1;
		{% endfor %}
                        if (statetraces[0].y.length>0){ 
              i=0;

	      {% for ab in stateabbrevs%}
                       document.getElementById("startingstate{{forloop.counter}}").value = statetraces[i].y[0];  
             	       Plotly.restyle(document.getElementById("statetrajectories{{forloop.counter}}"),{x:[statetraces[i].x],y:[statetraces[i].y]},[0]);

                       i=i+1;
		{% endfor %}
               i = 0;
	      {% for ab in descon%}
             	       Plotly.restyle(document.getElementById("checkstatetrajectories{{forloop.counter}}"),{x:[checkstatetraces[2*i].x,checkstatetraces[2*i+1].x],y:[checkstatetraces[2*i].y,checkstatetraces[2*i+1].y]},[0,1]);

                       i=i+1;
		{% endfor %}

                        if (statetraces[0].x.length>1){ 
                 
                       var r = statetraces[0].x[1]-statetraces[0].x[0];
                       document.getElementById("dt").value=r.toFixed(2);}
                       else{
                       document.getElementById("dt").value = "1";

}
                   }
                   else {
	        i=0;
                {% for ab in stateabbrevs%}
                       document.getElementById("startingstate{{forloop.counter}}").value = "";
                      Plotly.restyle(document.getElementById("statetrajectories{{forloop.counter}}"),{x:[[]],y:[[]]},[0]);

                       i=i+1;
		{% endfor %}
               i = 0;
	      {% for ab in descon%}
             	       Plotly.restyle(document.getElementById("checkstatetrajectories{{forloop.counter}}"),{x:[[],[]],y:[[],[]]},[0,1]);

                       i=i+1;
		{% endfor %}

            }
    }

	      {% for ab in controlabbrevs%}
document.getElementById("controlinput{{forloop.counter}}").value = "";
		{% endfor %}

	      {% for ab in stateabbrevs%}
document.getElementById("startingstate{{forloop.counter}}").value = "";
		{% endfor %}
      var graphheight = 300;
      var gap = 0.05;
      var margin = 40;
      var graphwidth=500;
      var totalcontrolgraphwidth = graphwidth-2*margin;
      var totalcontrolgraphheight = graphheight*{{viabilityproblem.controldimension}}-2*margin;
      var plotheigh = (1-({{viabilityproblem.controldimension}}-1)*gap)/{{viabilityproblem.controldimension}};
      var plotheighplusgap = plotheigh+gap;
      initControlTrajPlot(10,gap,margin,graphheight,graphwidth,controltrajectories);
      initStateTrajPlot(10,gap,margin,graphheight,statetrajectories);
      initCheckStateTrajPlot(10,gap,margin,graphheight,checkstatetrajectories);

            {% for ab in controlabbrevs%}

      document.getElementById("controltrajectories{{forloop.counter}}").on('plotly_click', function(data){

         var str = document.getElementById("infobis").innerHTML;
         var lx = parseFloat(str.split("(")[1]);
         var ly = parseFloat(str.split(",")[1]);
         var n = parseInt(str.split("plot")[1]);

           document.getElementById("infobis").innerHTML = 'Point ('+lx+','+ly+') removed from plot'+n;
           document.getElementById("infobisnew").innerHTML = 'Point ('+lx+','+ly+') removed from plot'+n;

         var control = document.getElementById('controlinput'+n);
         control.value = control.value.replace('('+lx+','+ly+')',''); 

         updateTrajectories(n);

	});

      document.getElementById("controltrajectories{{forloop.counter}}").on('plotly_hover', function(data){
              var lx = data.points[0].x;
              var ly = data.points[0].y;
           document.getElementById("infobis").innerHTML = 'Click to remove point ('+lx+','+ly+') from plot {{forloop.counter}}';
           document.getElementById("infobisnew").innerHTML = 'Click to remove point ('+lx+','+ly+') from plot {{forloop.counter}}';

	});
      document.getElementById("controltrajectories{{forloop.counter}}").on('plotly_unhover', function(data){
           document.getElementById("infobis").innerHTML = 'Clik on a graph point to remove it :';
           document.getElementById("infobisnew").innerHTML = 'Clik on a graph point to remove it :';

	});
             {% endfor %}

      document.getElementById("controltrajectories").on('plotly_click', function(data){

         var str = document.getElementById("infobis").innerHTML;
         var lx = parseFloat(str.split("(")[1]);
         var ly = parseFloat(str.split(",")[1]);
         var n = parseInt(str.split("plot")[1]);

           document.getElementById("infobis").innerHTML = 'Point ('+lx+','+ly+') removed from plot'+n;
           document.getElementById("infobisnew").innerHTML = 'Point ('+lx+','+ly+') removed from plot'+n;

         var control = document.getElementById('controlinput'+n);
         control.value = control.value.replace('('+lx+','+ly+')',''); 

         updateTrajectories(n);

	});

      document.getElementById("controltrajectories").on('plotly_hover', function(data){
              var lx = data.points[0].x;
              var ly = data.points[0].y;
             var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

              var number = data.points[0].curveNumber-rang;
              var n= (number-1)/2+1;
           document.getElementById("infobis").innerHTML = 'Click to remove point ('+lx+','+ly+') from plot '+n;
           document.getElementById("infobisnew").innerHTML = 'Click to remove point ('+lx+','+ly+') from plot '+n;

	});
      document.getElementById("controltrajectories").on('plotly_unhover', function(data){
           document.getElementById("infobis").innerHTML = 'Clik on a graph point to remove it :';
           document.getElementById("infobisnew").innerHTML = 'Clik on a graph point to remove it :';

	});


      function initControlTrajPlot(maxtime,gap,margin,graphheight,graphwidth,container){
              var plotheighinpx = graphheight*{{viabilityproblem.controldimension}};
	      var layout = {paper_bgcolor: "#7f7f7f",plot_bgcolor: "#c7c7c7",autosize:false,showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin,pad:0},width: graphwidth,height: plotheighinpx,xaxis:{title : 't',range:[0,maxtime],domain: [0,1]},hovermode:'closest'};
              var plotheigh = (1-({{viabilityproblem.controldimension}}-1)*gap)/{{viabilityproblem.controldimension}};
              var i = 0;
	      var traces = [];
             {% for ab in controlabbrevs%}
                 init = i*(plotheigh+gap);
                 layout['yaxis'+(i+1)] = {title: '{{ab}}', range:[-1,1],domain:[init,init+plotheigh]}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'pink' }, hoverinfo: 'none',yaxis: 'y'+(i+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' }, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 i=i+1
             {% endfor %}
	     Plotly.newPlot(container,traces,layout);
//           document.getElementById("info").innerHTML =layout.yaxis1.title;
	}
      function initStateTrajPlot(maxtime,gap,margin,graphheight,container){
              var plotheighinpx = graphheight*{{viabilityproblem.statedimension}};
	      var layout = {showlegend: false,margin:{t:10,l:margin,r:10,b:margin},width: 500,height: plotheighinpx,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'};
              var plotheigh = (1-({{viabilityproblem.statedimension}}-1)*gap)/{{viabilityproblem.statedimension}};
              var i = 0;
	      var traces = [];
             {% for ab in stateabbrevs%}
                 init = i*(plotheigh+gap);
                 layout['yaxis'+(i+1)] = {title: '{{ab}}',domain:[init,init+plotheigh]}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 i=i+1
             {% endfor %}
	     Plotly.newPlot(container,traces,layout);
//           document.getElementById("info").innerHTML =layout.yaxis1.title;
	}

      function createAnnotation(){
              var annot = {x: 0.5,    xanchor: 'right',    y: 0,    yanchor: 'bottom',text:'yop',xref : 'paper',yref:'paper',showarrow : false};
     
        return annot;
     }
      function initCheckStateTrajPlot(maxtime,gap,margin,graphheight,container){
              var plotheighinpx = graphheight*{{ldescon}};

	      var layout = {annotations:[],showlegend: false,margin:{t:margin,l:margin,r:margin,b:margin},width: 500,height: plotheighinpx,xaxis:{title : 't',range:[0,maxtime]},hovermode:'closest'};
              var plotheigh = (1-({{ldescon}}-1)*gap)/{{ldescon}};
              var i = 0;
	      var traces = [];
             {% for ab in descon%}
                 init = i*(plotheigh+gap);
                 annot = createAnnotation();
                 annot.y = init+plotheigh;
                 annot.text = 'Condition : {{ab}}';
                 layout.annotations.push(annot);
                 layout['yaxis'+(i+1)] = {title: '',domain:[init,init+plotheigh]}
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'blue' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });
                 traces.push({x:[],y:[], mode:'lines+markers', type: 'scatter', marker: { size : 10, color: 'red' ,cmin : 0, cmax : 2}, hoverinfo: 'x+y',yaxis: 'y'+(i+1) });

                 i=i+1
             {% endfor %}
	     Plotly.newPlot(container,traces,layout);
//           document.getElementById("info").innerHTML =layout.yaxis1.title;
	}

      function positioncurseuringraph(y){
        var newy = [-1];
        var ystar = y/(totalcontrolgraphheight*plotheighplusgap);
         var r =  ystar % 1;
         r = r*plotheighplusgap/plotheigh;
         r = r.toFixed(2);
//document.getElementById("info").innerHTML = r;
         if (r<= 1){
             newy[0] = r;
             newy.push({{viabilityproblem.controldimension}}-parseInt(ystar));
          }
        return newy;
      }
      function findPos(el) {
	var x = y = 0;
	if(el.offsetParent) {
		x = el.offsetLeft;
		y = el.offsetTop;
		while(el = el.offsetParent) {
			x += el.offsetLeft;
			y += el.offsetTop;
		}
	}
	return {'x':x, 'y':y};
      }

     function addcursorpointNew(div){
         var container = document.getElementById(div.id);
         var str = document.getElementById("info").innerHTML;
         var lx = parseFloat(str.split("(")[1]);
         var ly = parseFloat(str.split(",")[1]);
         var n = parseInt(str.split("plotcontroltrajectories")[1]);

         var lastt = 0;
         if (container.data[1].x.length>0){ lastt = container.data[1].x[container.data[1].x.length-1];} 
         if ((isNaN(lx)== false)&&(isNaN(ly)== false)&&(isNaN(n)== false)&&(lx>=lastt)){
           xnewpink = [lx];
           ynewpink = [ly];
           xnewred = container.data[1].x.concat([lx]);
           ynewred = container.data[1].y.concat([ly]);

           document.getElementById("info").innerHTML = 'Point ('+lx+','+ly+') added to plotcontroltrajectories'+n;
           document.getElementById("infonew").innerHTML = 'Point ('+lx+','+ly+') added to plotcontroltrajectories'+n;

         var control = document.getElementById('controlinput'+n);
         control.value = control.value+'('+lx+','+ly+')'; 
         updateTrajectories(n);

       }
else{
//           document.getElementById("info").innerHTML = 'Merde';

}
     }


     function addcursorpoint(){
         var container = document.getElementById("controltrajectories");
         var str = document.getElementById("info").innerHTML;
         var lx = parseFloat(str.split("(")[1]);
         var ly = parseFloat(str.split(",")[1]);
         var n = parseInt(str.split("plot")[1]);
         var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

         var number = 2*(n-1)+rang;
         var lastt = 0;
         if (container.data[number+1].x.length>0){ lastt = container.data[number+1].x[container.data[number+1].x.length-1];} 
         if ((isNaN(lx)== false)&&(isNaN(ly)== false)&&(isNaN(n)== false)&&(lx>=lastt)){
           xnewpink = [lx];
           ynewpink = [ly];
           xnewred = container.data[number+1].x.concat([lx]);
           ynewred = container.data[number+1].y.concat([ly]);

           document.getElementById("info").innerHTML = 'Point ('+lx+','+ly+') added to plot'+n;
           document.getElementById("infonew").innerHTML = 'Point ('+lx+','+ly+') added to plot'+n;

         var control = document.getElementById('controlinput'+n);
         control.value = control.value+'('+lx+','+ly+')'; 
         updateTrajectories(n);

       }
else{
//           document.getElementById("info").innerHTML = 'Merde';

}
     }


      function erasepinkNew(div){

         var container = document.getElementById(div.id);

                 if (container.data[0].x.length >1 ){

                  update = {x:[[container.data[0].x[0]]],y:[[container.data[0].y[0]]]}
//                var update = {x:[[0,9]],y:[[1,1]]};

		Plotly.restyle(container,update,[0]);
                }
             
     }

      function erasepink(){
         var container = document.getElementById("controltrajectories");
         var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

               for(i = 0;i<{{viabilityproblem.controldimension}};i++){
                 if (container.data[rang+2*i].x.length >1 ){

                  update = {x:[[container.data[rang+2*i].x[0]]],y:[[container.data[rang+2*i].y[0]]]}
//                var update = {x:[[0,9]],y:[[1,1]]};

		Plotly.restyle(container,update,[rang+2*i]);
                }
             }
     }
     function positioncurseurNew(div,event){
         var container = document.getElementById(div.id);
         var pos = findPos(container);
         var px = event.pageX-pos.x-margin;
         var py = event.pageY-pos.y-margin;

         if ((py>=0)&&(px>=0)&&(px<=400-40-40)&&(py<=300-40-40)){
             var range = container.layout['yaxis'].range;
             var ly = py/(300-40-40); 
             ly = range[1]-ly*(range[1]-range[0]);
             range = container.layout['xaxis'].range;
             var lx = px/(400-40-40);
             lx = lx.toFixed(2);
             lx = lx*range[1];
             lx = lx.toFixed(2);
             ly = ly.toFixed(2);

//             py = container.data[0].xaxis.p2l(py);
             document.getElementById("info").innerHTML = 'Add point ('+lx+','+ly+') to plot'+ div.id;
             document.getElementById("infonew").innerHTML = 'Add point ('+lx+','+ly+') to plot'+ div.id;

             if (container.data[0].x.length >0 ){
                var update = {x:[[container.data[0].x[0],lx]],y:[[container.data[0].y[0],ly]]}
//                var update = {x:[[0,9]],y:[[1,1]]};

		Plotly.restyle(container,update,[0]);

             }
       }
       else {
             erasepinkNew(div);
             document.getElementById("info").innerHTML = 'Click on graph below to draw piecewise linear control functions : ';
             document.getElementById("infonew").innerHTML = 'Click on graph below to draw piecewise linear control functions : ';

       } 
     }

     function positioncurseur(event){
         var container = document.getElementById("controltrajectories");
         var pos = findPos(container);
         var px = event.pageX-pos.x-margin;
         var py = event.pageY-pos.y-margin;
         var sition = positioncurseuringraph(py);
         py = sition[0];

         if ((py>=0)&&(px>=0)&&(px<=totalcontrolgraphwidth)){
            var ny = sition[1];
            var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;

            var number = 2*(ny-1)+rang;

             if (ny>1){
               var str = 'yaxis'+sition[1];
             }
             else{
               var str = 'yaxis';
             }
             var range = container.layout[str].range;
             var ly = range[1]-py*(range[1]-range[0]);
             range = container.layout['xaxis'].range;
             var lx = px/totalcontrolgraphwidth;
             lx = lx.toFixed(2);
             lx = lx*range[1];
             lx = lx.toFixed(2);
             ly = ly.toFixed(2);

//             py = container.data[0].xaxis.p2l(py);
             document.getElementById("info").innerHTML = 'Add point ('+lx+','+ly+') to plot'+sition[1];
             document.getElementById("infonew").innerHTML = 'Add point ('+lx+','+ly+') to plot'+sition[1];

             if (container.data[number].x.length >0 ){
                var update = {x:[[container.data[number].x[0],lx]],y:[[container.data[number].y[0],ly]]}
//                var update = {x:[[0,9]],y:[[1,1]]};

		Plotly.restyle(container,update,[number]);

             }
       }
       else {
             erasepink();
             document.getElementById("info").innerHTML = 'Click on graph below to draw piecewise linear control functions : ';
             document.getElementById("infonew").innerHTML = 'Click on graph below to draw piecewise linear control functions : ';

       } 
     }

      function arecorrects(){
        var b = true;      
        if ((isNaN(parseFloat(document.getElementById('horizon').value))) || (isNaN(parseFloat(document.getElementById('dt').value))) ||(parseFloat(document.getElementById('horizon').value) <=0)||(parseFloat(document.getElementById('dt').value) <=0)){ b = false;}
        if (b == true){
        for (var i = 1;i<={{viabilityproblem.statedimension}};i++) {
           if (isNaN(parseFloat(document.getElementById('startingstate'+i).value))) {b = false;}
        }
        }
//        document.getElementById("info").innerHTML = b;
        return b;
      }

      function iscorrect(str){
        var tab = [];
        var t = [];
        var u = [];  
        var b = true;
        if (str != ""){
          if (str[0] != '('){
 	      b = false;
//              document.getElementById("essai").innerHTML = "error1";
}
          else if (str[str.length-1] != ')'){
 	      b = false;
//              document.getElementById("essai").innerHTML = "error2"+str[str.length-1];
}
          else { 
               donnees = str.split(")(");
               donnees[0] = donnees[0].replace("(","");
               donnees[donnees.length-1] = donnees[donnees.length-1].replace(")","");
              lasttimevalue = 0;
              for (var i = 0;i< donnees.length;i++) {
		dd = donnees[i].split(",");
		if (dd.length != 2){ b = false; //document.getElementById("essai").innerHTML = donnees[i];
                }
                else if (isNaN(parseFloat(dd[0]))){b = false;//document.getElementById("essai").innerHTML = dd[0];
                }
                else if (parseFloat(dd[0]) < lasttimevalue){b = false;//document.getElementById("essai").innerHTML = dd[0];
                }
                else if (isNaN(parseFloat(dd[1]))){b = false;//document.getElementById("essai").innerHTML = dd[1];
                 }
                else{
                     lasttimevalue = parseFloat(dd[0]);
		     t.push(dd[0]);
		     u.push(dd[1]);
	
                }
	   } 
	 }
       }
       tab.push(b);
       tab.push(t);
       tab.push(u);

          return tab;
      }


      function updateboundscontrolTrajectories(number){
        minu = parseFloat(document.getElementById("mincontrolinput"+number).value);
        maxu = parseFloat(document.getElementById("maxcontrolinput"+number).value);

        if ((isNaN(minu) == false)&&(isNaN(maxu) == false)&&(minu<maxu)){
        var update = {yaxis:{range : [minu,maxu]}};
        Plotly.relayout(controltrajectories, update)
        }
      }


      function updateTrajectoriesHorizon(){
        var horizon =  parseFloat(document.getElementById("horizon").value);
        if (isNaN(horizon) == false){
        var update = {xaxis:{range : [0,horizon]}};
        Plotly.relayout(controltrajectories, update)
        Plotly.relayout(statetrajectories, update)
       }
      }

      function updatecontrolTrajectories(number){
          var tab = iscorrect(document.getElementById("controlinput"+number+"").value);
          if (tab[0] == true) {
              var containerTraj = document.getElementById('controltrajectories');
              var containerTrajbis = document.getElementById('controltrajectories'+number);

              if (tab[1].length>0) {
		xnew = [tab[1][tab[1].length-1]];
                ynew = [tab[2][tab[1].length-1]];
	      }
              else{
		xnew = [];
                ynew = [];

	      } 	
             var update = {x: [xnew,tab[1]],y:[ynew,tab[2]]};
             var rang = {{viabilityproblem.controldimension}}*2*evolutionactive;
//document.getElementById("info").innerHTML = "popo";
             Plotly.restyle(containerTraj, update, [rang+(number-1)*2,rang+(number-1)*2+1])
             Plotly.restyle(containerTrajbis, update, [0,1])

        }
      }

      function updateTrajectories(number){
             updatecontrolTrajectories(number);
             updatestateTrajectories();
      }

        function loadAndPlotbis(url,formdata,callback) {
            $.ajax({ url: url,
                    type: "POST",
                    data: formdata,
                    processData: false,
                    contentType: false,
                    dataType:"json",
                    success: callback,
                    complete: function(){
		}
            })
            return false;
        }


      function updatestateTrajectories(){
          var b = true;
          for (var i=1;i<={{viabilityproblem.controldimension}};i++){b = b && iscorrect(document.getElementById("controlinput"+i+"").value)[0];}
          if (b == true) {
              if (arecorrects()){
                var form = document.getElementById('controlinputform');
                var formdata = new FormData(form);
                var url = "{% url 'sharekernel:controltostate' result.id%}"
                var containerter;
                var checkstateindex;
                var checkdatanumber;
                var containerfive;
                var containerfivebis;
                var containerquad;
		var container = document.getElementById('controltrajectories');
		var containerbis = document.getElementById('checkstatetrajectories');
                var rang = {{viabilityproblem.statedimension}}*evolutionactive;
                var colori = container.data[rang+1].marker.color;
                for (i=0;i<tabcolors.length;i++){
                 if( tabcolors[i].indexOf(colori)!=-1){
                        indice = i;

                     }
                }

                container = document.getElementById('statetrajectories');
                loadAndPlotbis(url,formdata,function(data){
                      $.each(data, function(index,bar) {
                        if (index == 0){
                           checkstateindex = 1;
                           checkdatanumber =0;
			    color = bar;
                           for ( i=0;i<color.length;i++){
                             color[i] = tabcolors[indice][2-color[i]];
                          }
                        }
                        else if(index == 1){
			    times = bar;
                        } 
                        else if (index<{{viabilityproblem.statedimension}}+2){
			    container.data[rang+index-2].x = times;
			    container.data[rang+index-2].y = bar;
			    container.data[rang+index-2].marker.color = color;
		            containerter = document.getElementById('statetrajectories'+(index-1));
			    containerter.data[0].x = times;
			    containerter.data[0].y = bar;
			    containerter.data[0].marker.color = color;
         		    Plotly.redraw(containerter);
                            for (j=0;j<{{viabilityproblem.statedimension}};j++){
				if ((j+1)!=(index-1)){		            	
					str='2Dstatetrajectories'+(j+1);
	                            	containerfive = document.getElementById(str+(index-1));
					containerfive.data[0].y = bar;

					str='2Dstatetrajectories'+(index-1);
	                            	containerfivebis = document.getElementById(str+(j+1));

					containerfivebis.data[0].x = bar;


                    		}

			}
                            

                        }
                        else {
                            rang = {{ldescon}}*2*evolutionactive;
 			    containerbis.data[rang+index-2-{{viabilityproblem.statedimension}}].x = times;
			    containerbis.data[rang+index-2-{{viabilityproblem.statedimension}}].y = bar;
		            containerquad = document.getElementById('checkstatetrajectories'+checkstateindex);
 			    containerquad.data[checkdatanumber].x = times;
			    containerquad.data[checkdatanumber].y = bar;
                            if (checkdatanumber == 0){
				checkdatanumber = 1;
			}
                            else{
				checkdatanumber = 0;
				checkstateindex = checkstateindex+1; 
			}
         		    Plotly.redraw(containerquad);

                        }



			})	

			Plotly.redraw(container);
			Plotly.redraw(containerbis);
                        for (j=0;j<{{viabilityproblem.statedimension}};j++){
                        for (i=0;i<{{viabilityproblem.statedimension}};i++){
				if (i!=j){		            	
					str='2Dstatetrajectories'+(j+1);
                    			containerfive.data[0].marker.color = color;

	                            	containerfive = document.getElementById(str+(i+1));

                	      		Plotly.redraw(containerfive);

                    		}}}

                });
              }
        }
      }

      function makeViableTrajectories(){
          var b = true;
          for (var i=1;i<={{viabilityproblem.controldimension}};i++){b = b && iscorrect(document.getElementById("controlinput"+i+"").value)[0];}
          for (var i=1;i<={{viabilityproblem.controldimension}};i++){b = b && (isNaN(parseFloat(document.getElementById("controlstep"+i+"").value)) == false);}

          if (b == true) {
//              console.log("coucou")
              if (arecorrects()){
                var form = document.getElementById('controlinputform');
                var formdata = new FormData(form);
                var url = "{% url 'sharekernel:makeEvolutionViable' result.id%}"
                var containerter;
                var checkstateindex;
                var checkdatanumber;
                var containerfive;
                var containerfivebis;
                var containerquad;
		var container = document.getElementById('controltrajectories');
		var containerbis = document.getElementById('checkstatetrajectories');
                var rang = {{viabilityproblem.statedimension}}*evolutionactive;
                var colori = container.data[rang+1].marker.color;
                for (i=0;i<tabcolors.length;i++){
                 if( tabcolors[i].indexOf(colori)!=-1){
                        indice = i;

                     }
                }

                container = document.getElementById('statetrajectories');
                loadAndPlotbis(url,formdata,function(data){
                      $.each(data, function(index,bar) {
                        if (index == 0){
                           checkstateindex = 1;
                           checkdatanumber =0;
			    color = bar;
                           for ( i=0;i<color.length;i++){
                             color[i] = tabcolors[indice][2-color[i]];
                          }
                        }
                        else if(index == 1){
			    times = bar;
                        } 
                        else if (index<{{viabilityproblem.statedimension}}+2){
			    container.data[rang+index-2].x = times;
			    container.data[rang+index-2].y = bar;
			    container.data[rang+index-2].marker.color = color;
		            containerter = document.getElementById('statetrajectories'+(index-1));
			    containerter.data[0].x = times;
			    containerter.data[0].y = bar;
			    containerter.data[0].marker.color = color;
         		    Plotly.redraw(containerter);
                            for (j=0;j<{{viabilityproblem.statedimension}};j++){
				if ((j+1)!=(index-1)){		            	
					str='2Dstatetrajectories'+(j+1);
	                            	containerfive = document.getElementById(str+(index-1));
					containerfive.data[0].y = bar;

					str='2Dstatetrajectories'+(index-1);
	                            	containerfivebis = document.getElementById(str+(j+1));

					containerfivebis.data[0].x = bar;


                    		}

			}
                            

                        }
                        else {
                            rang = {{ldescon}}*2*evolutionactive;
 			    containerbis.data[rang+index-2-{{viabilityproblem.statedimension}}].x = times;
			    containerbis.data[rang+index-2-{{viabilityproblem.statedimension}}].y = bar;
		            containerquad = document.getElementById('checkstatetrajectories'+checkstateindex);
 			    containerquad.data[checkdatanumber].x = times;
			    containerquad.data[checkdatanumber].y = bar;
                            if (checkdatanumber == 0){
				checkdatanumber = 1;
			}
                            else{
				checkdatanumber = 0;
				checkstateindex = checkstateindex+1; 
			}
         		    Plotly.redraw(containerquad);

                        }



			})	

			Plotly.redraw(container);
			Plotly.redraw(containerbis);
                        for (j=0;j<{{viabilityproblem.statedimension}};j++){
                        for (i=0;i<{{viabilityproblem.statedimension}};i++){
				if (i!=j){		            	
					str='2Dstatetrajectories'+(j+1);
	                            	containerfive = document.getElementById(str+(i+1));

                	      		Plotly.redraw(containerfive);

                    		}}}

                });
              }
        }
      }

function loadAndPlot(url, callback) {
$('#loading').show();
$.ajax({ url: url,
        type: "POST",
        data: new FormData($('#uploadForm')[0]),
        processData: false,
        contentType: false,
        dataType:"json",
        success: callback,
        complete: function(){
        $('#loading').hide();
//			document.getElementById('loading').innerHTML = "";
        }
})
        return false;
}
$("#loading").ajaxStart(function(){ // Nous ciblons l'élément #loading qui est caché
    $(this).hide(); // Nous l'affichons quand la requête AJAX démarre
}).ajaxComplete(function() {
    $(this).hide();
});

function bargridRectangle(x, y, xstep, ystep, colorline, fillcolor){
    var rectangle = {'type': 'rect', 'x0': x[0] - xstep, 'y0': y[0] - ystep, 'x1': x[1] + xstep, 'y1': y[1] + ystep, 'line': {'color': colorline, 'width': 1}, 'fillcolor': fillcolor};
    return rectangle;
}

function bargridPlot(url, x, container, colormarker, colorline, fillcolor){
    if (isNaN(x) || x == "%20" || x > 1000) {
        text = "Input not valid : " + x;
        container.innerHTML = text;
    } else {
        url = url.replace("0", x);
        loadAndPlot(url, function (data) {
            var items = {x:[], y:[], mode:'markers', type: 'scatter', marker: { size : 2, color: colormarker }, hoverinfo:'none' };
            var trace = [];
            var tracebis = [];
            var x = [];
            var y = [];
            var map = [];
            var mapinit = [x, y];
            var mapitems = [];
            var mapinititems = [items.x, items.y];
            var xstep, ystep;
            var xbounds = [];
            var ybounds = [];
            $.each(data, function(index, bar) {
                if (index == 0){
                    xstep = bar[4] / 2;
                    ystep = bar[5] / 2;
                    xbounds.push(bar[0]);
                    xbounds.push(bar[2]);
                    ybounds.push(bar[1]);
                    ybounds.push(bar[3]);
                    map.push(mapinit[bar[6]]);
                    map.push(mapinit[bar[7]]);
                    mapitems.push(mapinititems[bar[6]]);
                    mapitems.push(mapinititems[bar[7]]);
                    x.push(0);
                    x.push(1);
                    y.push(0);
                    y.push(1);
                } else {
                    map[0][0] = bar[0];
                    map[0][1] = bar[0];
                    map[1][0] = bar[1];
                    map[1][1] = bar[2];
                    mapitems[0].push(bar[0]);
                    mapitems[0].push(bar[0]);
                    mapitems[1].push(bar[1]);
                    mapitems[1].push(bar[2]);
                    tracebis.push(bargridRectangle(x, y, xstep, ystep, colorline, fillcolor));
                }
            });
//            var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, shapes : tracebis, xaxis:{range : xbounds}, yaxis:{range : ybounds}};
            update = {shapes:tracebis};
            trace = [items];
            Plotly.relayout(container,update);
        })
    }
}

function kdtreeRectangle(xmin, xmax, ymin, ymax, colorline, fillcolor){
    var rectangle = {'type': 'rect', 'x0': xmin, 'y0': ymin, 'x1': xmax, 'y1': ymax, 'line': {'color': colorline, 'width': 1}, 'fillcolor': fillcolor};
    return rectangle;
}

function kdtreePlot(url, container, colormarker, colorline, fillcolor){
    loadAndPlot(url, function (data) {
        var items = {x:[], y:[], mode:'markers', type: 'scatter', marker: { size : 2, color: 'rgb(55, 128, 191)' }, hoverinfo:'none' };
        var trace = [];
        var tracebis = [];
        var xbounds = [];
        var ybounds = [];
        $.each(data, function(index, bar) {
            if (index > 0){
                items.x.push(bar[0]);
                items.y.push(bar[1]);
                tracebis.push(kdtreeRectangle(bar[2], bar[3], bar[4], bar[5], colorline, fillcolor));
            } else{
                xbounds.push(bar[0]);
                xbounds.push(bar[2]);
                ybounds.push(bar[1]);
                ybounds.push(bar[3]);
            }
        });
//        var layout = {showlegend: false, margin:{t:10}, width: 600, height: 500, shapes : tracebis, xaxis:{range : xbounds}, yaxis:{range : ybounds}};
//        trace = [items];
//        Plotly.newPlot(container, trace, layout);
            update = {shapes:tracebis};
            Plotly.relayout(container,update);

    })
}

$("#deletePlotlyBW").click(function(){
     
            var container = document.getElementById('2Dstatetrajectories12');

            update = {shapes:[]};
            Plotly.relayout(container,update);


})

$("#viewPlotlyBW").click(function(){
    {% if result.parameters.viabilityproblem.statedimension == 2 %}
        var url = "{% url 'sharekernel:ViNOView2D' result.id 0 %}"
//            console.log("coucoubis")
//            console.log('{{result.resultformat.title}}')

        {% if result.resultformat.title == 'bars' %}
//            document.getElementById('2Dstatetrajectories12').innerHTML = "";
            var x = document.getElementById("ppa").value;
            var container = document.getElementById('2Dstatetrajectories12');
            var colormarker = 'rgb(255,0,0,0.4)';
            var colorline = 'rgba(128, 0, 128, 1)';
            var fillcolor = 'rgba(128, 0, 128, 0.7)';
            bargridPlot(url, x, container, colormarker, colorline, fillcolor);
        {% elif result.resultformat.title == 'kdtree' %}
            var container = document.getElementById('2Dstatetrajectories12');
            var colormarker = 'rgb(255,0,0,0.4)';
            var colorline = 'rgba(128, 0, 128, 1)';
            var fillcolor = 'rgba(128, 0, 128, 0.7)';
            kdtreePlot(url, container, colormarker, colorline, fillcolor);
        {% endif %}
    {% endif %}
});

</script>    
{% endblock %}
